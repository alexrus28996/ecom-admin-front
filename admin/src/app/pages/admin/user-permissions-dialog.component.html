<h2 mat-dialog-title class="dialog-title">
  <mat-icon>shield_person</mat-icon>
  {{ 'adminUsers.permissions.title' | translate }}
</h2>

<mat-dialog-content class="permissions-dialog" [class.permissions-dialog--loading]="loading">
  <section class="user-summary">
    <div class="user-summary__info">
      <h3>{{ data.user?.name || (data.user?.email || data.user?.id) }}</h3>
      <p class="user-summary__email">{{ data.user?.email }}</p>
      <div class="user-summary__meta">
        <mat-chip-set aria-label="Roles" *ngIf="data.user?.roles?.length">
          <mat-chip
            *ngFor="let role of data.user.roles"
            [color]="role === 'admin' ? 'primary' : undefined"
            [selected]="role === 'admin'"
          >
            {{ role }}
          </mat-chip>
        </mat-chip-set>
        <span class="badge badge--neutral" *ngIf="!data.user?.roles?.length">
          {{ 'adminUsers.permissions.noRoles' | translate }}
        </span>
      </div>
    </div>
    <div class="user-summary__actions">
      <button
        mat-stroked-button
        color="primary"
        type="button"
        (click)="promote()"
        [disabled]="!canPromote() || promoteLoading"
      >
        <mat-progress-spinner *ngIf="promoteLoading" diameter="16" mode="indeterminate"></mat-progress-spinner>
        <mat-icon *ngIf="!promoteLoading">upgrade</mat-icon>
        {{ 'adminUsers.permissions.actions.promote' | translate }}
      </button>
      <button
        mat-stroked-button
        color="warn"
        type="button"
        (click)="demote()"
        [disabled]="!canDemote() || demoteLoading"
      >
        <mat-progress-spinner *ngIf="demoteLoading" diameter="16" mode="indeterminate"></mat-progress-spinner>
        <mat-icon *ngIf="!demoteLoading">download</mat-icon>
        {{ 'adminUsers.permissions.actions.demote' | translate }}
      </button>
      <p class="user-summary__hint" *ngIf="data.isLastAdmin && canDemote()">
        <mat-icon color="warn">warning</mat-icon>
        {{ 'adminUsers.permissions.lastAdminWarning' | translate }}
      </p>
    </div>
  </section>

  <section class="permissions-callout">
    <mat-icon color="primary">info</mat-icon>
    <div>
      <h4>{{ 'adminUsers.permissions.instructions.title' | translate }}</h4>
      <p>{{ 'adminUsers.permissions.instructions.body' | translate }}</p>
    </div>
  </section>

  <section class="permissions-toolbar">
    <mat-form-field appearance="outline">
      <mat-label>{{ 'adminUsers.permissions.search.label' | translate }}</mat-label>
      <input matInput [formControl]="searchControl" [placeholder]="'adminUsers.permissions.search.placeholder' | translate" />
      <button mat-icon-button matSuffix type="button" (click)="searchControl.setValue('')" *ngIf="searchControl.value">
        <mat-icon>clear</mat-icon>
      </button>
    </mat-form-field>
    <div class="permissions-toolbar__actions">
      <button mat-button type="button" (click)="selectAll()" [disabled]="loading">
        <mat-icon>select_all</mat-icon>
        {{ 'adminUsers.permissions.actions.selectAll' | translate }}
      </button>
      <button mat-button type="button" color="warn" (click)="clearAll()" [disabled]="loading">
        <mat-icon>clear_all</mat-icon>
        {{ 'adminUsers.permissions.actions.clearAll' | translate }}
      </button>
    </div>
  </section>

  <app-error-banner [key]="loadErrorKey"></app-error-banner>

  <div class="permissions-spinner" *ngIf="loading">
    <mat-progress-spinner diameter="40" mode="indeterminate"></mat-progress-spinner>
  </div>

  <ng-container *ngIf="!loading && !loadErrorKey">
    <ng-container *ngIf="filteredGroups().length; else permissionsEmpty">
      <mat-accordion displayMode="flat" multi class="permissions-list">
        <mat-expansion-panel *ngFor="let group of filteredGroups(); trackBy: trackByGroup" [expanded]="true">
          <mat-expansion-panel-header>
            <mat-panel-title>
              <mat-icon>folder</mat-icon>
              {{ group.label }}
            </mat-panel-title>
            <mat-panel-description>
              {{ group.items.filter((item) => isGranted(item.id)).length }}/{{ group.items.length }}
            </mat-panel-description>
          </mat-expansion-panel-header>
          <div class="group-actions">
            <button mat-button type="button" (click)="toggleGroup(group, true)" [disabled]="loading">
              <mat-icon>done_all</mat-icon>
              {{ 'adminUsers.permissions.actions.grantGroup' | translate }}
            </button>
            <button mat-button type="button" (click)="toggleGroup(group, false)" [disabled]="loading">
              <mat-icon>remove_done</mat-icon>
              {{ 'adminUsers.permissions.actions.revokeGroup' | translate }}
            </button>
          </div>
          <div class="group-permissions">
            <div class="permission-item" *ngFor="let permission of group.items; trackBy: trackByPermission">
              <mat-checkbox
                [checked]="isGranted(permission.id)"
                (change)="togglePermission(permission, $event.checked)"
                [disabled]="isToggling(permission.id)"
              >
                <span class="permission-item__label">{{ permission.label }}</span>
                <span class="permission-item__code">{{ permission.id }}</span>
              </mat-checkbox>
              <button
                mat-icon-button
                type="button"
                class="permission-item__info"
                [matTooltip]="permission.description || permission.label"
                aria-label="{{ permission.label }}"
              >
                <mat-icon>info</mat-icon>
              </button>
              <mat-progress-spinner *ngIf="isToggling(permission.id)" diameter="18" mode="indeterminate"></mat-progress-spinner>
            </div>
          </div>
        </mat-expansion-panel>
      </mat-accordion>
    </ng-container>
    <ng-template #permissionsEmpty>
      <div class="permissions-empty">
        <mat-icon>search_off</mat-icon>
        <p>{{ 'adminUsers.permissions.empty' | translate }}</p>
      </div>
    </ng-template>
  </ng-container>
</mat-dialog-content>

<mat-dialog-actions align="end" class="permissions-actions">
  <button mat-button type="button" (click)="close()">
    {{ 'common.close' | translate }}
  </button>
  <span class="permissions-actions__spacer"></span>
  <button mat-flat-button color="primary" type="button" (click)="saveAll()" [disabled]="!hasChanges() || saveLoading">
    <mat-progress-spinner *ngIf="saveLoading" diameter="16" mode="indeterminate"></mat-progress-spinner>
    <mat-icon *ngIf="!saveLoading">save</mat-icon>
    {{ 'adminUsers.permissions.actions.saveAll' | translate }}
  </button>
</mat-dialog-actions>
