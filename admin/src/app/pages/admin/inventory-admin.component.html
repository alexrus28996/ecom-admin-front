<div class="page inventory-shell">
  <section class="page__header">
    <div class="page__headline">
      <div>
        <span class="page__eyebrow">{{ 'inventory.eyebrow' | translate }}</span>
        <h1>{{ 'inventory.title' | translate }}</h1>
        <p>{{ 'inventory.subtitle' | translate }}</p>
      </div>
      <div class="page__actions">
        <button mat-stroked-button color="primary" type="button" (click)="refreshAll()" [disabled]="invLoading || lowLoading">
          <mat-icon>refresh</mat-icon>
          {{ 'inventory.actions.refresh' | translate }}
        </button>
        <button mat-raised-button color="primary" type="button" (click)="openAdjustmentDialog()">
          <mat-icon>inventory</mat-icon>
          {{ 'inventory.actions.newAdjustment' | translate }}
        </button>
      </div>
    </div>
  </section>

  <div class="inventory-sections">
    <mat-card class="inventory-card">
      <mat-card-header>
        <mat-card-title>{{ 'inventory.overview.title' | translate }}</mat-card-title>
        <mat-card-subtitle>{{ 'inventory.overview.subtitle' | translate }}</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <mat-tab-group class="inventory-tabs" [(selectedIndex)]="inventoryTabIndex" (selectedIndexChange)="onInventoryTabChange($event)">
          <mat-tab label="{{ 'inventory.tabs.overview' | translate }}">
            <form [formGroup]="invFilters" class="inventory-filters" (ngSubmit)="loadInv()">
              <mat-form-field appearance="outline">
                <mat-label>{{ 'inventory.filters.product' | translate }}</mat-label>
                <input matInput formControlName="product" />
              </mat-form-field>
              <mat-form-field appearance="outline">
                <mat-label>{{ 'inventory.filters.variant' | translate }}</mat-label>
                <input matInput formControlName="variant" />
              </mat-form-field>
              <mat-form-field appearance="outline">
                <mat-label>{{ 'inventory.filters.location' | translate }}</mat-label>
                <input matInput formControlName="location" />
              </mat-form-field>
              <mat-form-field appearance="outline">
                <mat-label>{{ 'inventory.filters.status' | translate }}</mat-label>
                <mat-select formControlName="stockStatus">
                  <mat-option *ngFor="let option of invStatusOptions" [value]="option.value">{{ option.labelKey | translate }}</mat-option>
                </mat-select>
              </mat-form-field>
              <div class="inventory-filters__actions">
                <button mat-button type="button" (click)="invFilters.reset({ product: '', variant: '', location: '', stockStatus: 'all' }); loadInv();" [disabled]="invLoading">
                  {{ 'common.actions.reset' | translate }}
                </button>
                <button mat-raised-button color="primary" type="submit" [disabled]="invLoading">
                  <mat-icon>filter_alt</mat-icon>
                  {{ 'common.actions.apply' | translate }}
                </button>
              </div>
            </form>
            <section class="inventory-table">
              <app-loading [show]="invLoading" labelKey="common.loading"></app-loading>
              <div class="data-table" *ngIf="inv.items.length; else invEmpty">
                <table mat-table [dataSource]="inv.items" class="data-table__table">
                  <ng-container matColumnDef="product">
                    <th mat-header-cell *matHeaderCellDef>{{ 'inventory.table.product' | translate }}</th>
                    <td mat-cell *matCellDef="let row">
                      <div class="inventory-product">
                        <div class="inventory-product__thumb" [ngClass]="{ 'inventory-product__thumb--empty': !row.productImage }">
                          <img *ngIf="row.productImage" [src]="row.productImage" [alt]="row.productName" loading="lazy" />
                          <mat-icon *ngIf="!row.productImage">inventory_2</mat-icon>
                        </div>
                        <div class="inventory-product__meta">
                          <div class="inventory-product__name">{{ row.productName }}</div>
                          <div class="inventory-product__sku" *ngIf="row.productSku">
                            {{ 'inventory.table.productSku' | translate:{ sku: row.productSku } }}
                          </div>
                        </div>
                      </div>
                    </td>
                  </ng-container>

                  <ng-container matColumnDef="variant">
                    <th mat-header-cell *matHeaderCellDef>{{ 'inventory.table.variantSku' | translate }}</th>
                    <td mat-cell *matCellDef="let row">{{ row.variantSku || ('inventory.table.noVariant' | translate) }}</td>
                  </ng-container>

                  <ng-container matColumnDef="stock">
                    <th mat-header-cell *matHeaderCellDef>{{ 'inventory.table.currentStock' | translate }}</th>
                    <td mat-cell *matCellDef="let row">
                      <div class="inventory-stock" [ngClass]="'inventory-stock--' + row.status">
                        <span class="inventory-stock__value">{{ row.stock }}</span>
                        <span class="inventory-stock__badge" *ngIf="row.status !== 'in-stock'">
                          {{ ('inventory.status.' + row.status) | translate }}
                        </span>
                      </div>
                    </td>
                  </ng-container>

                  <ng-container matColumnDef="reorder">
                    <th mat-header-cell *matHeaderCellDef>{{ 'inventory.table.reorderPoint' | translate }}</th>
                    <td mat-cell *matCellDef="let row">{{ row.reorderPoint ?? ('inventory.table.notSet' | translate) }}</td>
                  </ng-container>

                  <ng-container matColumnDef="updated">
                    <th mat-header-cell *matHeaderCellDef>{{ 'inventory.table.updatedAt' | translate }}</th>
                    <td mat-cell *matCellDef="let row">{{ row.updatedAt ? (row.updatedAt | date: 'short') : ('inventory.table.never' | translate) }}</td>
                  </ng-container>

                  <ng-container matColumnDef="actions">
                    <th mat-header-cell *matHeaderCellDef>{{ 'inventory.table.actions' | translate }}</th>
                    <td mat-cell *matCellDef="let row">
                      <div class="inventory-actions">
                        <button
                          mat-icon-button
                          color="primary"
                          type="button"
                          (click)="openAdjustmentDialog(row)"
                          matTooltip="{{ 'inventory.actions.adjust' | translate }}"
                          aria-label="{{ 'inventory.actions.adjust' | translate }}"
                        >
                          <mat-icon>edit_note</mat-icon>
                        </button>
                        <button
                          mat-icon-button
                          type="button"
                          (click)="viewHistory(row)"
                          matTooltip="{{ 'inventory.actions.viewHistory' | translate }}"
                          aria-label="{{ 'inventory.actions.viewHistory' | translate }}"
                        >
                          <mat-icon>history</mat-icon>
                        </button>
                      </div>
                    </td>
                  </ng-container>

                  <tr mat-header-row *matHeaderRowDef="['product','variant','stock','reorder','updated','actions']; sticky: true"></tr>
                  <tr mat-row *matRowDef="let row; columns: ['product','variant','stock','reorder','updated','actions']"></tr>
                </table>
              </div>
              <ng-template #invEmpty>
                <div class="empty-state">
                  <mat-icon>inventory_2</mat-icon>
                  <p>{{ 'inventory.overview.empty' | translate }}</p>
                </div>
              </ng-template>
              <app-error-banner [key]="invErrorKey"></app-error-banner>
            </section>
            <mat-paginator
              [length]="inv.total"
              [pageIndex]="inv.page"
              [pageSize]="inv.pageSize"
              [pageSizeOptions]="[10,25,50,100]"
              (page)="pageInv($event)"
              showFirstLastButtons
            ></mat-paginator>
          </mat-tab>

          <mat-tab label="{{ 'inventory.tabs.lowStock' | translate }}">
            <form [formGroup]="lowFilters" class="inventory-filters" (ngSubmit)="loadLow()">
              <mat-form-field appearance="outline">
                <mat-label>{{ 'inventory.filters.threshold' | translate }}</mat-label>
                <input matInput type="number" min="0" formControlName="threshold" />
              </mat-form-field>
              <div class="inventory-filters__actions">
                <button mat-button type="button" (click)="lowFilters.reset({ threshold: 10 }); loadLow();" [disabled]="lowLoading">
                  {{ 'common.actions.reset' | translate }}
                </button>
                <button mat-raised-button color="primary" type="submit" [disabled]="lowLoading">
                  <mat-icon>filter_alt</mat-icon>
                  {{ 'common.actions.apply' | translate }}
                </button>
              </div>
            </form>
            <section class="inventory-table">
              <app-loading [show]="lowLoading" labelKey="common.loading"></app-loading>
              <div class="data-table" *ngIf="low.items.length; else lowEmpty">
                <table mat-table [dataSource]="low.items" class="data-table__table">
                  <ng-container matColumnDef="product">
                    <th mat-header-cell *matHeaderCellDef>{{ 'inventory.low.table.product' | translate }}</th>
                    <td mat-cell *matCellDef="let row">
                      <div class="inventory-product">
                        <div class="inventory-product__thumb" [ngClass]="{ 'inventory-product__thumb--empty': !row.productImage }">
                          <img *ngIf="row.productImage" [src]="row.productImage" [alt]="row.productName" loading="lazy" />
                          <mat-icon *ngIf="!row.productImage">inventory_2</mat-icon>
                        </div>
                        <div class="inventory-product__meta">
                          <div class="inventory-product__name">{{ row.productName }}</div>
                          <div class="inventory-product__sku" *ngIf="row.variantSku">
                            {{ 'inventory.table.variantLabel' | translate:{ sku: row.variantSku } }}
                          </div>
                        </div>
                      </div>
                    </td>
                  </ng-container>
                  <ng-container matColumnDef="stock">
                    <th mat-header-cell *matHeaderCellDef>{{ 'inventory.low.table.currentStock' | translate }}</th>
                    <td mat-cell *matCellDef="let row">
                      <div class="inventory-stock inventory-stock--low">
                        <span class="inventory-stock__value">{{ row.stock }}</span>
                        <span class="inventory-stock__badge inventory-stock__badge--alert">
                          {{ 'inventory.low.badge' | translate }}
                        </span>
                      </div>
                    </td>
                  </ng-container>
                  <ng-container matColumnDef="reorder">
                    <th mat-header-cell *matHeaderCellDef>{{ 'inventory.low.table.reorderPoint' | translate }}</th>
                    <td mat-cell *matCellDef="let row">{{ row.reorderPoint ?? ('inventory.table.notSet' | translate) }}</td>
                  </ng-container>
                  <ng-container matColumnDef="updated">
                    <th mat-header-cell *matHeaderCellDef>{{ 'inventory.low.table.updatedAt' | translate }}</th>
                    <td mat-cell *matCellDef="let row">{{ row.updatedAt ? (row.updatedAt | date: 'short') : ('inventory.table.never' | translate) }}</td>
                  </ng-container>
                  <tr mat-header-row *matHeaderRowDef="['product','stock','reorder','updated']; sticky: true"></tr>
                  <tr mat-row *matRowDef="let row; columns: ['product','stock','reorder','updated']"></tr>
                </table>
              </div>
              <ng-template #lowEmpty>
                <div class="empty-state">
                  <mat-icon>report</mat-icon>
                  <p>{{ 'inventory.low.empty' | translate }}</p>
                </div>
              </ng-template>
              <app-error-banner [key]="lowErrorKey"></app-error-banner>
            </section>
            <mat-paginator
              [length]="low.total"
              [pageIndex]="low.page"
              [pageSize]="low.pageSize"
              [pageSizeOptions]="[10,25,50,100]"
              (page)="pageLow($event)"
              showFirstLastButtons
            ></mat-paginator>
          </mat-tab>
        </mat-tab-group>
      </mat-card-content>
    </mat-card>

    <mat-card class="inventory-card" #adjustmentsSection>
      <mat-card-header>
        <mat-card-title>{{ 'inventory.adjustments.title' | translate }}</mat-card-title>
        <mat-card-subtitle>{{ 'inventory.adjustments.subtitle' | translate }}</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content class="inventory-card__content">
        <form [formGroup]="adjFilters" class="inventory-filters" (ngSubmit)="loadAdj()">
          <mat-form-field appearance="outline">
            <mat-label>{{ 'inventory.filters.product' | translate }}</mat-label>
            <input matInput formControlName="product" />
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label>{{ 'inventory.filters.variant' | translate }}</mat-label>
            <input matInput formControlName="variant" />
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label>{{ 'inventory.filters.reason' | translate }}</mat-label>
            <input matInput formControlName="reason" />
          </mat-form-field>
          <div class="inventory-filters__actions">
            <button mat-button type="button" (click)="adjFilters.reset({ product: '', variant: '', reason: '' }); loadAdj();" [disabled]="adjLoading">
              {{ 'common.actions.reset' | translate }}
            </button>
            <button mat-raised-button color="primary" type="submit" [disabled]="adjLoading">
              <mat-icon>filter_alt</mat-icon>
              {{ 'common.actions.apply' | translate }}
            </button>
          </div>
        </form>
        <section class="inventory-table">
          <app-loading [show]="adjLoading" labelKey="common.loading"></app-loading>
          <div class="data-table" *ngIf="adj.items.length; else adjEmpty">
            <table mat-table [dataSource]="adj.items" class="data-table__table">
              <ng-container matColumnDef="date">
                <th mat-header-cell *matHeaderCellDef>{{ 'inventory.adjustments.table.date' | translate }}</th>
                <td mat-cell *matCellDef="let row">{{ row.createdAt ? (row.createdAt | date: 'short') : ('inventory.table.never' | translate) }}</td>
              </ng-container>
              <ng-container matColumnDef="product">
                <th mat-header-cell *matHeaderCellDef>{{ 'inventory.table.product' | translate }}</th>
                <td mat-cell *matCellDef="let row">{{ row.productName }}</td>
              </ng-container>
              <ng-container matColumnDef="variant">
                <th mat-header-cell *matHeaderCellDef>{{ 'inventory.table.variantSku' | translate }}</th>
                <td mat-cell *matCellDef="let row">{{ row.variantSku || ('inventory.table.noVariant' | translate) }}</td>
              </ng-container>
              <ng-container matColumnDef="qty">
                <th mat-header-cell *matHeaderCellDef>{{ 'inventory.adjustments.table.qtyChange' | translate }}</th>
                <td mat-cell *matCellDef="let row">
                  <span [ngClass]="{ 'qty-positive': row.qtyChange > 0, 'qty-negative': row.qtyChange < 0 }">
                    {{ row.qtyChange > 0 ? '+' : '' }}{{ row.qtyChange }}
                  </span>
                </td>
              </ng-container>
              <ng-container matColumnDef="reason">
                <th mat-header-cell *matHeaderCellDef>{{ 'inventory.adjustments.table.reason' | translate }}</th>
                <td mat-cell *matCellDef="let row">
                  {{ ('inventory.adjustments.reasons.' + (row.reason || 'other')) | translate }}
                </td>
              </ng-container>
              <ng-container matColumnDef="user">
                <th mat-header-cell *matHeaderCellDef>{{ 'inventory.adjustments.table.user' | translate }}</th>
                <td mat-cell *matCellDef="let row">{{ row.userName || ('inventory.adjustments.table.system' | translate) }}</td>
              </ng-container>
              <tr mat-header-row *matHeaderRowDef="['date','product','variant','qty','reason','user']; sticky: true"></tr>
              <tr mat-row *matRowDef="let row; columns: ['date','product','variant','qty','reason','user']"></tr>
            </table>
          </div>
          <ng-template #adjEmpty>
            <div class="empty-state">
              <mat-icon>list_alt</mat-icon>
              <p>{{ 'inventory.adjustments.empty' | translate }}</p>
            </div>
          </ng-template>
          <app-error-banner [key]="adjErrorKey"></app-error-banner>
        </section>
      </mat-card-content>
      <mat-card-actions align="end">
        <mat-paginator
          [length]="adj.total"
          [pageIndex]="adj.page"
          [pageSize]="adj.pageSize"
          [pageSizeOptions]="[10,25,50,100]"
          (page)="pageAdj($event)"
          showFirstLastButtons
        ></mat-paginator>
      </mat-card-actions>
    </mat-card>
  </div>
</div>
