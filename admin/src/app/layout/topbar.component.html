<header class="topbar" role="banner">
  <!-- Left Section: Mobile Menu & Branding -->
  <div class="topbar__left">
    <button
      mat-icon-button
      type="button"
      class="topbar__menu-btn"
      *ngIf="isHandset"
      (click)="menuClick.emit()"
      [attr.aria-label]="'shell.topbar.menu.toggleNav' | translate"
      [matTooltip]="'shell.topbar.menu.toggleNav' | translate"
      matTooltipPosition="below">
      <mat-icon>menu</mat-icon>
    </button>

    <!-- Company Brand (visible on mobile) -->
    <div class="topbar__brand" *ngIf="isHandset">
      <div class="topbar__logo">
        <mat-icon>admin_panel_settings</mat-icon>
      </div>
      <div class="topbar__brand-text">
        <span class="topbar__brand-name">Admin Panel</span>
      </div>
    </div>
  </div>

  <!-- Center Section: Contextual Search -->
  <div class="topbar__center">
    <form
      class="topbar__search"
      (ngSubmit)="submit()"
      novalidate
      *ngIf="searchEnabled; else searchDisabledTpl">
      <div class="topbar__search-context" *ngIf="searchModule">
        <mat-icon>{{ searchIcon }}</mat-icon>
        <span>{{ searchModule }}</span>
      </div>
      <mat-form-field appearance="outline" class="topbar__search-field">
        <mat-label>{{ searchModule ? searchModule + ' search' : 'Global search' }}</mat-label>
        <input
          matInput
          [formControl]="searchControl"
          [placeholder]="searchPlaceholder"
          autocomplete="off"
        />
        <mat-icon matPrefix>{{ searchIcon }}</mat-icon>
        <mat-hint *ngIf="searchHint">{{ searchHint }}</mat-hint>
        <button
          mat-icon-button
          matSuffix
          type="submit"
          [attr.aria-label]="searchPlaceholder"
          *ngIf="searchControl.value"
          class="topbar__search-submit">
          <mat-icon>arrow_forward</mat-icon>
        </button>
      </mat-form-field>
    </form>
  </div>

  <ng-template #searchDisabledTpl>
    <div class="topbar__search topbar__search--disabled">
      <mat-icon>search_off</mat-icon>
      <span>Search unavailable for this view</span>
    </div>
  </ng-template>

  <!-- Right Section: Actions & Profile -->
  <div class="topbar__actions">
    <!-- Loading Indicator -->
    <div class="topbar__refresh" *ngIf="refreshing">
      <mat-progress-spinner
        mode="indeterminate"
        diameter="24"
        strokeWidth="3"
        color="primary"
        aria-label="Loading">
      </mat-progress-spinner>
    </div>

    <!-- Theme Toggle -->
    <button
      mat-icon-button
      type="button"
      class="topbar__action-btn"
      (click)="toggleTheme.emit()"
      [matTooltip]="(isDark ? 'Switch to light theme' : 'Switch to dark theme')"
      [attr.aria-label]="(isDark ? 'Switch to light theme' : 'Switch to dark theme')">
      <mat-icon>{{ isDark ? 'light_mode' : 'dark_mode' }}</mat-icon>
    </button>

    <!-- Notifications -->
    <button
      mat-icon-button
      type="button"
      class="topbar__action-btn topbar__notifications"
      [matTooltip]="'Notifications'"
      [attr.aria-label]="'Notifications'">
      <mat-icon>notifications</mat-icon>
      <span class="topbar__notification-badge" aria-label="3 unread notifications">3</span>
    </button>

    <!-- User Profile Menu -->
    <button
      mat-stroked-button
      type="button"
      class="topbar__profile-btn"
      [matMenuTriggerFor]="profileMenu"
      *ngIf="user; else anonymous">
      <div class="topbar__profile-content">
        <div
          class="topbar__avatar"
          [class.topbar__avatar--image]="!!user?.avatarUrl"
          [style.background-image]="user?.avatarUrl ? 'url(' + user?.avatarUrl + ')' : ''">
          <ng-container *ngIf="!user?.avatarUrl">{{ avatarInitials }}</ng-container>
        </div>
        <div class="topbar__profile-text" *ngIf="!isHandset">
          <span class="topbar__profile-name">{{ user?.name || 'Anonymous' }}</span>
          <small class="topbar__profile-email">{{ user?.email || 'No email' }}</small>
        </div>
        <mat-icon class="topbar__profile-arrow">expand_more</mat-icon>
      </div>
    </button>

    <ng-template #anonymous>
      <button
        mat-stroked-button
        type="button"
        class="topbar__profile-btn"
        [matMenuTriggerFor]="profileMenu">
        <div class="topbar__profile-content">
          <div class="topbar__avatar">
            <mat-icon>person</mat-icon>
          </div>
          <div class="topbar__profile-text" *ngIf="!isHandset">
            <span class="topbar__profile-name">Guest User</span>
            <small class="topbar__profile-email">Not signed in</small>
          </div>
          <mat-icon class="topbar__profile-arrow">expand_more</mat-icon>
        </div>
      </button>
    </ng-template>

    <!-- Enhanced Profile Menu -->
    <mat-menu #profileMenu="matMenu" class="topbar__profile-menu">
      <div class="topbar__profile-header" mat-menu-item disabled>
        <div class="topbar__profile-info">
          <div
            class="topbar__profile-avatar"
            [class.topbar__profile-avatar--image]="!!user?.avatarUrl"
            [style.background-image]="user?.avatarUrl ? 'url(' + user?.avatarUrl + ')' : ''">
            <ng-container *ngIf="!user?.avatarUrl">{{ avatarInitials }}</ng-container>
          </div>
          <div class="topbar__profile-details">
            <strong>{{ user?.name || 'Guest User' }}</strong>
            <small>{{ user?.email || 'Not signed in' }}</small>
            <div class="topbar__profile-role">
              <mat-icon>admin_panel_settings</mat-icon>
              <span>Administrator</span>
            </div>
          </div>
        </div>
      </div>

      <mat-divider></mat-divider>

      <button mat-menu-item routerLink="/profile">
        <mat-icon>account_circle</mat-icon>
        <span>My Profile</span>
      </button>

      <button mat-menu-item routerLink="/admin/settings">
        <mat-icon>settings</mat-icon>
        <span>Settings</span>
      </button>

      <button mat-menu-item>
        <mat-icon>help_outline</mat-icon>
        <span>Help & Support</span>
      </button>

      <mat-divider></mat-divider>

      <button mat-menu-item type="button" (click)="logout.emit()" class="topbar__logout-btn">
        <mat-icon>logout</mat-icon>
        <span>Sign Out</span>
      </button>
    </mat-menu>
  </div>
</header>
