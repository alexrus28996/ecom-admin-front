<header class="topbar" role="banner">
  <div class="topbar__row">
    <div class="topbar__section topbar__section--left">
      <button
        mat-icon-button
        type="button"
        class="topbar__nav-toggle"
        *ngIf="isHandset"
        (click)="menuClick.emit()"
        aria-label="Open navigation"
        matTooltip="Open navigation"
        matTooltipPosition="below">
        <mat-icon>menu</mat-icon>
      </button>

      <button
        mat-icon-button
        type="button"
        class="topbar__nav-toggle"
        *ngIf="!isHandset"
        (click)="toggleSidebar.emit()"
        [attr.aria-label]="navCollapsed ? 'Expand navigation' : 'Collapse navigation'"
        [matTooltip]="navCollapsed ? 'Expand navigation' : 'Collapse navigation'"
        matTooltipPosition="below">
        <mat-icon>{{ navCollapsed ? 'chevron_right' : 'chevron_left' }}</mat-icon>
      </button>

      <div class="topbar__brand">
        <div class="topbar__brand-logo">
          <mat-icon>admin_panel_settings</mat-icon>
        </div>
        <div class="topbar__brand-meta">
          <span class="topbar__brand-title">Commerce Admin</span>
          <span class="topbar__brand-subtitle" *ngIf="!isHandset">Operations Console</span>
        </div>
      </div>
    </div>

    <div class="topbar__section topbar__section--center">
      <form
        class="topbar__search"
        [class.topbar__search--disabled]="!searchEnabled"
        (ngSubmit)="submit()"
        novalidate>
        <div class="topbar__search-meta" *ngIf="searchModule || searchHint">
          <span class="topbar__search-module" *ngIf="searchModule">{{ searchModule }}</span>
          <span class="topbar__search-hint" *ngIf="searchHint">{{ searchHint }}</span>
        </div>

        <mat-form-field appearance="outline" class="topbar__search-field">
          <mat-label>{{ searchPlaceholder }}</mat-label>
          <mat-icon matPrefix>{{ searchIcon }}</mat-icon>
          <input
            matInput
            [formControl]="searchControl"
            [placeholder]="searchPlaceholder"
            [disabled]="!searchEnabled"
            autocomplete="off" />
          <button
            mat-icon-button
            matSuffix
            type="submit"
            [disabled]="!searchEnabled || !(searchControl?.value?.toString().trim())"
            aria-label="Search">
            <mat-icon>arrow_forward</mat-icon>
          </button>
        </mat-form-field>
      </form>
    </div>

    <div class="topbar__section topbar__section--right">
      <div class="topbar__refresh" *ngIf="refreshing">
        <mat-progress-spinner
          mode="indeterminate"
          diameter="24"
          strokeWidth="3"
          color="primary"
          aria-label="Loading">
        </mat-progress-spinner>
      </div>

      <button
        mat-icon-button
        type="button"
        class="topbar__action"
        (click)="toggleTheme.emit()"
        [attr.aria-label]="isDark ? 'Switch to light theme' : 'Switch to dark theme'"
        [matTooltip]="isDark ? 'Switch to light theme' : 'Switch to dark theme'">
        <mat-icon>{{ isDark ? 'light_mode' : 'dark_mode' }}</mat-icon>
      </button>

      <ng-container *ngIf="user; else guestMenu">
        <button
          mat-stroked-button
          type="button"
          class="topbar__profile"
          [matMenuTriggerFor]="profileMenu"
          aria-label="Open account menu">
          <div
            class="topbar__avatar"
            [class.topbar__avatar--image]="!!user?.avatarUrl"
            [style.background-image]="user?.avatarUrl ? 'url(' + user?.avatarUrl + ')' : ''">
            <ng-container *ngIf="!user?.avatarUrl">{{ avatarInitials }}</ng-container>
          </div>
          <div class="topbar__profile-meta" *ngIf="!isHandset">
            <span class="topbar__profile-name">{{ user?.name || user?.email }}</span>
            <small class="topbar__profile-email">{{ user?.email }}</small>
          </div>
          <mat-icon>expand_more</mat-icon>
        </button>
      </ng-container>

      <ng-template #guestMenu>
        <button
          mat-stroked-button
          type="button"
          class="topbar__profile"
          [matMenuTriggerFor]="profileMenu"
          aria-label="Open account menu">
          <div class="topbar__avatar">
            <mat-icon>person</mat-icon>
          </div>
          <div class="topbar__profile-meta" *ngIf="!isHandset">
            <span class="topbar__profile-name">Guest</span>
            <small class="topbar__profile-email">Sign in</small>
          </div>
          <mat-icon>expand_more</mat-icon>
        </button>
      </ng-template>

      <mat-menu #profileMenu="matMenu" class="topbar__menu">
        <div class="topbar__menu-header" mat-menu-item disabled>
          <div class="topbar__menu-avatar">
            <div
              class="topbar__avatar"
              [class.topbar__avatar--image]="!!user?.avatarUrl"
              [style.background-image]="user?.avatarUrl ? 'url(' + user?.avatarUrl + ')' : ''">
              <ng-container *ngIf="!user?.avatarUrl">{{ avatarInitials }}</ng-container>
            </div>
            <div class="topbar__menu-meta">
              <strong>{{ user?.name || 'Guest user' }}</strong>
              <small>{{ user?.email || 'Not signed in' }}</small>
            </div>
          </div>
        </div>
        <mat-divider></mat-divider>
        <button mat-menu-item routerLink="/profile">
          <mat-icon>account_circle</mat-icon>
          <span>Profile</span>
        </button>
        <button mat-menu-item routerLink="/admin/settings">
          <mat-icon>settings</mat-icon>
          <span>Admin Settings</span>
        </button>
        <mat-divider></mat-divider>
        <button mat-menu-item type="button" (click)="logout.emit()">
          <mat-icon>logout</mat-icon>
          <span>Logout</span>
        </button>
      </mat-menu>
    </div>
  </div>

  <div class="topbar__row topbar__row--breadcrumbs" *ngIf="breadcrumbs?.length">
    <nav class="topbar__breadcrumbs" aria-label="Breadcrumb">
      <ng-container *ngFor="let crumb of breadcrumbs; let last = last">
        <a
          *ngIf="!last && crumb.url"
          [routerLink]="crumb.url"
          class="topbar__breadcrumb-link"
          [attr.aria-label]="crumb.label">
          {{ crumb.translationKey ? (crumb.translationKey | translate) : crumb.label }}
        </a>
        <span
          *ngIf="last || !crumb.url"
          class="topbar__breadcrumb-current">
          {{ crumb.translationKey ? (crumb.translationKey | translate) : crumb.label }}
        </span>
        <mat-icon *ngIf="!last" class="topbar__breadcrumb-separator">chevron_right</mat-icon>
      </ng-container>
    </nav>
  </div>
</header>
