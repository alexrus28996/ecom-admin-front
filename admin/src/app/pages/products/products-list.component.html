<ng-container *ngIf="productPermissions$ | async as perms">
<div class="products-panel">
  <header class="products-panel__header">
    <div class="products-panel__title">
      <div class="products-panel__icon">
        <mat-icon>inventory_2</mat-icon>
      </div>
      <div class="products-panel__copy">
        <h1>{{ 'products.title' | translate }}</h1>
        <p>{{ 'products.subtitle' | translate }}</p>
      </div>
    </div>
    <div class="products-panel__meta">
      <div class="products-panel__stats" *ngIf="total > 0">
        <div class="stat-chip">
          <span class="stat-chip__label">{{ 'products.stats.total' | translate }}</span>
          <span class="stat-chip__value">{{ total }}</span>
        </div>
        <div class="stat-chip">
          <span class="stat-chip__label">{{ 'products.stats.active' | translate }}</span>
          <span class="stat-chip__value">{{ activeCount }}</span>
        </div>
      </div>
      <div class="products-panel__actions">
        <input
          #importFileInput
          type="file"
          accept=".json,application/json,.csv,text/csv"
          (change)="handleFileImport($event)"
          hidden
        />
        <span
          class="action-tooltip-wrapper"
          [matTooltip]="actionTooltipKey('refresh', perms) | translate"
          [matTooltipDisabled]="!actionTooltipKey('refresh', perms)"
          [class.is-disabled]="isActionDisabled('refresh', perms)"
          (click)="onDisabledAction($event, 'refresh', perms)"
        >
          <button mat-stroked-button color="primary" type="button" (click)="onSubmit()" [disabled]="isActionDisabled('refresh', perms)">
            <mat-icon>refresh</mat-icon>
            {{ 'products.actions.refresh' | translate }}
          </button>
        </span>
        <span
          class="action-tooltip-wrapper"
          [matTooltip]="actionTooltipKey('import', perms) | translate"
          [matTooltipDisabled]="!actionTooltipKey('import', perms)"
          [class.is-disabled]="isActionDisabled('import', perms)"
          (click)="onDisabledAction($event, 'import', perms)"
        >
          <button mat-stroked-button color="accent" type="button" (click)="onImportClick()" [disabled]="isActionDisabled('import', perms)">
            <mat-icon>file_upload</mat-icon>
            {{ 'products.import.title' | translate }}
          </button>
        </span>
        <span
          class="action-tooltip-wrapper"
          [matTooltip]="actionTooltipKey('export', perms) | translate"
          [matTooltipDisabled]="!actionTooltipKey('export', perms)"
          [class.is-disabled]="isActionDisabled('export', perms)"
          (click)="onDisabledAction($event, 'export', perms)"
        >
          <button
            mat-stroked-button
            color="accent"
            type="button"
            [disabled]="isActionDisabled('export', perms)"
            [matMenuTriggerFor]="exportMenu"
          >
            <mat-icon>file_download</mat-icon>
            {{ 'products.export.title' | translate }}
          </button>
        </span>
        <mat-menu #exportMenu="matMenu">
          <button mat-menu-item type="button" (click)="startExport('json')">
            <mat-icon>code</mat-icon>
            {{ 'products.export.options.json' | translate }}
          </button>
          <button mat-menu-item type="button" (click)="startExport('csv')">
            <mat-icon>table_chart</mat-icon>
            {{ 'products.export.options.csv' | translate }}
          </button>
        </mat-menu>
        <span
          class="action-tooltip-wrapper"
          [matTooltip]="actionTooltipKey('create', perms) | translate"
          [matTooltipDisabled]="!actionTooltipKey('create', perms)"
          [class.is-disabled]="isActionDisabled('create', perms)"
          (click)="onDisabledAction($event, 'create', perms)"
        >
          <button
            mat-raised-button
            color="primary"
            type="button"
            (click)="onAddProduct()"
            [disabled]="isActionDisabled('create', perms)"
          >
            <mat-icon>add</mat-icon>
            {{ 'products.add' | translate }}
          </button>
        </span>
      </div>
    </div>
  </header>

  <div class="products-panel__filters-wrapper">
    <form class="products-panel__filters" [formGroup]="filterForm" (ngSubmit)="onSubmit()" novalidate>
      <div class="filters-row filters-row--primary">
        <mat-form-field appearance="outline" class="search-field">
          <mat-label>{{ 'products.filters.search.label' | translate }}</mat-label>
          <input
            matInput
            formControlName="q"
            [placeholder]="'products.filters.search.placeholder' | translate"
          />
          <mat-icon matPrefix>search</mat-icon>
          <button mat-icon-button matSuffix type="button" (click)="clearSearch()" [disabled]="loading" *ngIf="filterForm.get('q')?.value">
            <mat-icon>clear</mat-icon>
          </button>
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>{{ 'products.filters.category.label' | translate }}</mat-label>
          <mat-select formControlName="category">
            <mat-option value="">{{ 'products.filters.category.any' | translate }}</mat-option>
            <mat-option *ngFor="let category of categories" [value]="category.id">{{ category.name }}</mat-option>
          </mat-select>
          <mat-icon matPrefix>category</mat-icon>
        </mat-form-field>
        <button mat-stroked-button type="button" (click)="toggleAdvancedFilters()" [class.active]="showAdvancedFilters">
          <mat-icon>{{ showAdvancedFilters ? 'expand_less' : 'tune' }}</mat-icon>
          {{ 'products.filters.advanced' | translate }}
        </button>
      </div>

      <div class="filters-row filters-row--advanced" [class.visible]="showAdvancedFilters">
        <div class="price-range">
          <mat-form-field appearance="outline">
            <mat-label>{{ 'products.filters.price.min' | translate }}</mat-label>
            <input matInput type="number" min="0" formControlName="priceMin" />
            <span matPrefix>$</span>
          </mat-form-field>
          <span class="price-range__separator">â€”</span>
          <mat-form-field appearance="outline">
            <mat-label>{{ 'products.filters.price.max' | translate }}</mat-label>
            <input matInput type="number" min="0" formControlName="priceMax" />
            <span matPrefix>$</span>
          </mat-form-field>
        </div>
        <mat-form-field appearance="outline">
          <mat-label>{{ 'products.filters.status.label' | translate }}</mat-label>
          <mat-select formControlName="status">
            <mat-option value="">{{ 'products.filters.status.any' | translate }}</mat-option>
            <mat-option value="active">{{ 'products.filters.status.active' | translate }}</mat-option>
            <mat-option value="inactive">{{ 'products.filters.status.inactive' | translate }}</mat-option>
          </mat-select>
          <mat-icon matPrefix>toggle_on</mat-icon>
        </mat-form-field>
        <button mat-stroked-button type="button" (click)="clearFilters()">
          <mat-icon>clear_all</mat-icon>
          {{ 'products.filters.clear' | translate }}
        </button>
      </div>
    </form>
  </div>

  <!-- Bulk Actions Bar -->
  <div class="bulk-actions-bar" *ngIf="bulkActionsVisible">
    <div class="bulk-actions-content">
      <span class="bulk-selection-count">
        {{ 'products.bulk.selected' | translate:{ count: selectedProducts.size } }}
      </span>
      <div class="bulk-actions">
        <button mat-stroked-button color="primary" (click)="bulkActivate()" [disabled]="bulkOperationInProgress">
          <mat-icon>check_circle</mat-icon>
          {{ 'products.bulk.activate' | translate }}
        </button>
        <button mat-stroked-button color="warn" (click)="bulkDeactivate()" [disabled]="bulkOperationInProgress">
          <mat-icon>cancel</mat-icon>
          {{ 'products.bulk.deactivate' | translate }}
        </button>
        <button mat-stroked-button color="warn" (click)="bulkDelete()" [disabled]="bulkOperationInProgress">
          <mat-icon>delete</mat-icon>
          {{ 'products.bulk.delete.action' | translate }}
        </button>
      </div>
    </div>
  </div>

  <section class="products-panel__table">
    <div class="table-wrapper" *ngIf="dataSource.length; else tableFallback">
      <table mat-table [dataSource]="dataSource" class="products-table">
        <ng-container matColumnDef="select">
          <th mat-header-cell *matHeaderCellDef>
            <mat-checkbox
              (change)="toggleAllSelection()"
              [checked]="isAllSelected()"
              [indeterminate]="selectedProducts.size > 0 && !isAllSelected()"
            ></mat-checkbox>
          </th>
          <td mat-cell *matCellDef="let product">
            <mat-checkbox
              (change)="toggleProductSelection(product)"
              [checked]="isProductSelected(product)"
            ></mat-checkbox>
          </td>
        </ng-container>
        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef>{{ 'products.name' | translate }}</th>
          <td mat-cell *matCellDef="let product">
            <div class="product-cell">
              <div class="product-cell__image">
                <img
                  [src]="getProductImage(product)"
                  [alt]="product.name"
                  class="product-thumbnail"
                  (error)="onImageError($event)"
                />
              </div>
              <div class="product-cell__content">
                <span class="product-cell__name">{{ product.name || ('common.empty' | translate) }}</span>
                <span class="product-cell__meta" *ngIf="product.sku">SKU: {{ product.sku }}</span>
                <div class="product-cell__status">
                  <span class="status-badge" [class.status-badge--active]="product.isActive" [class.status-badge--inactive]="!product.isActive">
                    {{ (product.isActive ? 'products.status.active' : 'products.status.inactive') | translate }}
                  </span>
                </div>
              </div>
            </div>
          </td>
        </ng-container>


        <ng-container matColumnDef="price">
          <th mat-header-cell *matHeaderCellDef>{{ 'products.price' | translate }}</th>
          <td mat-cell *matCellDef="let product">
            {{ priceAmount(product) | currency:priceCurrency(product):'symbol':'1.2-2' }}
          </td>
        </ng-container>

        <ng-container matColumnDef="brand">
          <th mat-header-cell *matHeaderCellDef>{{ 'products.brand' | translate }}</th>
          <td mat-cell *matCellDef="let product">{{ brandName(product) }}</td>
        </ng-container>

        <ng-container matColumnDef="categories">
          <th mat-header-cell *matHeaderCellDef>{{ 'products.categories' | translate }}</th>
          <td mat-cell *matCellDef="let product">{{ categoryNames(product) }}</td>
        </ng-container>

        <ng-container matColumnDef="stock">
          <th mat-header-cell *matHeaderCellDef>{{ 'products.table.stock' | translate }}</th>
          <td mat-cell *matCellDef="let product">
            <div class="stock-cell">
              <span class="stock-cell__value">{{ product.stock || 0 }}</span>
              <span class="stock-cell__status" [class.stock-cell__status--low]="isLowStock(product)" [class.stock-cell__status--out]="isOutOfStock(product)">
                {{ getStockStatus(product) | translate }}
              </span>
            </div>
          </td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef class="actions-header">{{ 'products.columns.actions' | translate }}</th>
          <td mat-cell *matCellDef="let product">
            <div class="row-actions">
              <span
                class="action-tooltip-wrapper"
                [matTooltip]="actionTooltipKey('edit', perms, product) | translate"
                [matTooltipDisabled]="!actionTooltipKey('edit', perms, product)"
                [class.is-disabled]="isActionDisabled('edit', perms, product)"
                (click)="onDisabledAction($event, 'edit', perms, product)"
              >
                <button
                  mat-icon-button
                  color="primary"
                  type="button"
                  (click)="onEditProduct(product)"
                  [disabled]="isActionDisabled('edit', perms, product)"
                >
                  <mat-icon>edit</mat-icon>
                </button>
              </span>
              <span
                class="action-tooltip-wrapper"
                [matTooltip]="actionTooltipKey('variants', perms, product) | translate"
                [matTooltipDisabled]="!actionTooltipKey('variants', perms, product)"
                [class.is-disabled]="isActionDisabled('variants', perms, product)"
                (click)="onDisabledAction($event, 'variants', perms, product)"
              >
                <button
                  mat-icon-button
                  color="accent"
                  type="button"
                  (click)="manageVariants(product)"
                  [disabled]="isActionDisabled('variants', perms, product)"
                >
                  <mat-icon>tune</mat-icon>
                </button>
              </span>
              <span
                class="action-tooltip-wrapper"
                [matTooltip]="actionTooltipKey('restore', perms, product) | translate"
                [matTooltipDisabled]="!actionTooltipKey('restore', perms, product)"
                [class.is-disabled]="isActionDisabled('restore', perms, product)"
                (click)="onDisabledAction($event, 'restore', perms, product)"
                *ngIf="isProductDeleted(product)"
              >
                <button
                  mat-icon-button
                  color="accent"
                  type="button"
                  (click)="confirmRestore(product)"
                  [disabled]="isActionDisabled('restore', perms, product)"
                >
                  <mat-icon>restore</mat-icon>
                </button>
              </span>
              <span
                class="action-tooltip-wrapper"
                [matTooltip]="actionTooltipKey('delete', perms, product) | translate"
                [matTooltipDisabled]="!actionTooltipKey('delete', perms, product)"
                [class.is-disabled]="isActionDisabled('delete', perms, product)"
                (click)="onDisabledAction($event, 'delete', perms, product)"
                *ngIf="!isProductDeleted(product)"
              >
                <button
                  mat-icon-button
                  color="warn"
                  type="button"
                  (click)="confirmDelete(product)"
                  [disabled]="isActionDisabled('delete', perms, product)"
                >
                  <mat-icon>delete</mat-icon>
                </button>
              </span>
            </div>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns; trackBy: trackById"></tr>
      </table>
    </div>
  </section>

  <ng-template #tableFallback>
    <div class="products-skeleton" *ngIf="loading">
      <div class="products-skeleton__header">
        <div class="products-skeleton__bar products-skeleton__bar--title"></div>
        <div class="products-skeleton__bar products-skeleton__bar--subtitle"></div>
      </div>
      <div class="products-skeleton__table">
        <div class="products-skeleton__row" *ngFor="let _ of skeletonRows">
          <div class="products-skeleton__cell">
            <div class="products-skeleton__image"></div>
            <div class="products-skeleton__content">
              <div class="products-skeleton__bar products-skeleton__bar--name"></div>
              <div class="products-skeleton__bar products-skeleton__bar--meta"></div>
            </div>
          </div>
          <div class="products-skeleton__cell">
            <div class="products-skeleton__bar products-skeleton__bar--price"></div>
          </div>
          <div class="products-skeleton__cell">
            <div class="products-skeleton__bar products-skeleton__bar--brand"></div>
          </div>
          <div class="products-skeleton__cell">
            <div class="products-skeleton__bar products-skeleton__bar--category"></div>
          </div>
          <div class="products-skeleton__cell">
            <div class="products-skeleton__bar products-skeleton__bar--stock"></div>
          </div>
          <div class="products-skeleton__cell">
            <div class="products-skeleton__actions">
              <div class="products-skeleton__action"></div>
              <div class="products-skeleton__action"></div>
              <div class="products-skeleton__action"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="empty-state" *ngIf="!loading">
      <div class="empty-state__icon">
        <mat-icon>inventory_2</mat-icon>
      </div>
      <div class="empty-state__content">
        <h3>{{ 'products.empty.title' | translate }}</h3>
        <p>{{ 'products.empty.subtitle' | translate }}</p>
        <button mat-raised-button color="primary" routerLink="/admin/products/new" *ngIf="perms.create">
          <mat-icon>add</mat-icon>
          {{ 'products.empty.action' | translate }}
        </button>
      </div>
    </div>
  </ng-template>

  <footer class="products-panel__footer" *ngIf="total > 0">
    <mat-paginator
      [length]="total"
      [pageIndex]="pageIndex"
      [pageSize]="pageSize"
      [pageSizeOptions]="pageSizeOptions"
      (page)="onPageChange($event)"
      showFirstLastButtons
    ></mat-paginator>
  </footer>

  <app-error-banner [key]="errorKey" [error]="lastError"></app-error-banner>
</div>

<ng-template #noDate>
  <span>{{ 'common.empty' | translate }}</span>
</ng-template>

</ng-container>
