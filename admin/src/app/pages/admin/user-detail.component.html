<div class="page page--panel user-detail" *ngIf="!loading; else loadingState">
  <section class="page__header">
    <div class="page__headline">
      <button mat-button type="button" (click)="navigateBack()">
        <mat-icon>arrow_back</mat-icon>
        {{ 'adminUsers.detail.actions.back' | translate }}
      </button>
      <h1>{{ user?.name || user?.email }}</h1>
      <p>{{ user?.email }}</p>
    </div>
    <div class="page__actions">
      <button
        mat-stroked-button
        color="primary"
        type="button"
        (click)="promote()"
        [disabled]="roleLoading || user?.roles?.includes('admin')"
      >
        <mat-progress-spinner *ngIf="roleLoading && !user?.roles?.includes('admin')" diameter="16" mode="indeterminate"></mat-progress-spinner>
        <mat-icon *ngIf="!roleLoading || user?.roles?.includes('admin')">upgrade</mat-icon>
        {{ 'adminUsers.list.actions.promote' | translate }}
      </button>
      <button
        mat-stroked-button
        color="warn"
        type="button"
        (click)="demote()"
        [disabled]="roleLoading || !user?.roles?.includes('admin')"
      >
        <mat-progress-spinner *ngIf="roleLoading && user?.roles?.includes('admin')" diameter="16" mode="indeterminate"></mat-progress-spinner>
        <mat-icon *ngIf="!roleLoading || !user?.roles?.includes('admin')">download</mat-icon>
        {{ 'adminUsers.list.actions.demote' | translate }}
      </button>
      <button
        mat-raised-button
        color="primary"
        type="button"
        (click)="openPermissions()"
      >
        <mat-icon>admin_panel_settings</mat-icon>
        {{ 'adminUsers.permissions.actions.manage' | translate }}
      </button>
    </div>
  </section>

  <section class="page__body" *ngIf="user; else errorState">
    <div class="user-detail__grid">
      <div class="user-detail__card">
        <h3>{{ 'adminUsers.detail.sections.profile' | translate }}</h3>
        <div class="user-detail__row">
          <span>{{ 'adminUsers.detail.fields.name' | translate }}</span>
          <strong>{{ user?.name || ('adminUsers.list.table.unknown' | translate) }}</strong>
        </div>
        <div class="user-detail__row">
          <span>{{ 'adminUsers.detail.fields.email' | translate }}</span>
          <strong>{{ user?.email }}</strong>
        </div>
        <div class="user-detail__row">
          <span>{{ 'adminUsers.detail.fields.roles' | translate }}</span>
          <mat-chip-set aria-label="Roles">
            <mat-chip *ngFor="let role of user?.roles" [color]="role === 'admin' ? 'primary' : undefined" [selected]="role === 'admin'">
              {{ role }}
            </mat-chip>
          </mat-chip-set>
        </div>
        <div class="user-detail__row">
          <span>{{ 'adminUsers.detail.fields.status' | translate }}</span>
          <div class="status-toggle">
            <mat-slide-toggle [checked]="user?.isActive" (change)="toggleActive()" [disabled]="statusLoading">
              {{ user?.isActive ? ('adminUsers.list.status.active' | translate) : ('adminUsers.list.status.inactive' | translate) }}
            </mat-slide-toggle>
            <mat-progress-spinner *ngIf="statusLoading" diameter="20" mode="indeterminate"></mat-progress-spinner>
          </div>
        </div>
      </div>
      <div class="user-detail__card">
        <h3>{{ 'adminUsers.detail.sections.activity' | translate }}</h3>
        <div class="user-detail__row">
          <span>{{ 'adminUsers.detail.fields.createdAt' | translate }}</span>
          <strong>{{ user?.createdAt | date: 'medium' }}</strong>
        </div>
        <div class="user-detail__row">
          <span>{{ 'adminUsers.detail.fields.updatedAt' | translate }}</span>
          <strong>{{ user?.updatedAt | date: 'medium' }}</strong>
        </div>
        <div class="user-detail__row">
          <span>{{ 'adminUsers.detail.fields.lastLogin' | translate }}</span>
          <strong>{{ user?.lastLoginAt | date: 'medium' }}</strong>
        </div>
        <div class="user-detail__row">
          <span>{{ 'adminUsers.detail.fields.verification' | translate }}</span>
          <strong>
            {{ user?.isVerified ? ('adminUsers.detail.status.verified' | translate) : ('adminUsers.detail.status.unverified' | translate) }}
          </strong>
        </div>
      </div>
    </div>
  </section>
</div>

<ng-template #loadingState>
  <div class="user-detail__loading">
    <mat-progress-spinner diameter="48" mode="indeterminate"></mat-progress-spinner>
    <p>{{ 'common.loading' | translate }}</p>
  </div>
</ng-template>

<ng-template #errorState>
  <app-error-banner [key]="errorKey"></app-error-banner>
</ng-template>
