<section class="product-form" [formGroup]="form">
  <header class="product-form__header">
    <div>
      <h1>{{ productId ? 'Edit product' : 'New product' }}</h1>
      <p>Configure product details, pricing, and variants.</p>
    </div>
    <div class="actions">
      <button mat-stroked-button type="button" (click)="cancel()">Cancel</button>
      <button
        mat-stroked-button
        color="primary"
        type="button"
        (click)="save(true)"
        [disabled]="saving || !canEdit"
        [matTooltip]="canEdit ? 'Save & Close' : 'Missing permission: product:edit'"
      >
        Save & Close
      </button>
      <button
        mat-raised-button
        color="primary"
        type="button"
        (click)="save()"
        [disabled]="saving || !canEdit"
        [matTooltip]="canEdit ? 'Save' : 'Missing permission: product:edit'"
      >
        Save
      </button>
    </div>
  </header>

  <mat-tab-group class="product-form__tabs">
    <mat-tab label="Details">
      <div class="tab-grid">
        <mat-form-field appearance="outline">
          <mat-label>Name</mat-label>
          <input matInput formControlName="name" required />
          <mat-error *ngIf="form.controls.name.hasError('required')">Name is required</mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Slug</mat-label>
          <input matInput formControlName="slug" required />
          <mat-error *ngIf="form.controls.slug.hasError('required')">Slug is required</mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Short description</mat-label>
          <textarea matInput formControlName="description" rows="3"></textarea>
        </mat-form-field>

        <mat-form-field appearance="outline" class="tab-grid__full">
          <mat-label>Long description</mat-label>
          <textarea matInput formControlName="longDescription" rows="6"></textarea>
        </mat-form-field>

        <mat-slide-toggle formControlName="isActive">Active</mat-slide-toggle>

        <mat-form-field appearance="outline">
          <mat-label>Category</mat-label>
          <input matInput formControlName="category" required placeholder="Category ID" />
          <mat-error *ngIf="form.controls.category.hasError('required')">Category is required</mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Brand</mat-label>
          <input matInput formControlName="brand" />
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Vendor</mat-label>
          <input matInput formControlName="vendor" />
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Tax class</mat-label>
          <input matInput formControlName="taxClass" />
        </mat-form-field>

        <div class="chips-input tab-grid__full">
          <mat-label>Tags</mat-label>
          <div class="chips-input__list">
            <mat-chip-list>
              <mat-chip *ngFor="let control of tagsArray.controls; let i = index" (removed)="removeTag(i)">
                {{ control.value }}
                <button matChipRemove><mat-icon>close</mat-icon></button>
              </mat-chip>
            </mat-chip-list>
          </div>
          <input matInput placeholder="Add tag" #tagInput (keyup.enter)="addTag(tagInput.value); tagInput.value = ''" />
        </div>
      </div>
    </mat-tab>

    <mat-tab label="Pricing">
      <div class="tab-grid">
        <mat-form-field appearance="outline">
          <mat-label>Price</mat-label>
          <input matInput type="number" min="0" formControlName="price" required />
          <mat-error *ngIf="form.controls.price.hasError('required')">Price is required</mat-error>
          <mat-error *ngIf="form.controls.price.hasError('min')">Must be non-negative</mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Compare at price</mat-label>
          <input matInput type="number" min="0" formControlName="compareAtPrice" />
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Cost price</mat-label>
          <input matInput type="number" min="0" formControlName="costPrice" />
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Currency</mat-label>
          <input matInput formControlName="currency" />
        </mat-form-field>
      </div>
    </mat-tab>

    <mat-tab label="Media">
      <app-product-image-uploader
        [images]="images"
        (imagesChange)="onImagesChange($event)"
        [editable]="canEdit"
      ></app-product-image-uploader>
    </mat-tab>

    <mat-tab label="SEO">
      <div class="tab-grid">
        <mat-form-field appearance="outline">
          <mat-label>Meta title</mat-label>
          <input matInput formControlName="metaTitle" />
        </mat-form-field>

        <mat-form-field appearance="outline" class="tab-grid__full">
          <mat-label>Meta description</mat-label>
          <textarea matInput formControlName="metaDescription" rows="4"></textarea>
        </mat-form-field>

        <div class="chips-input tab-grid__full">
          <mat-label>Meta keywords</mat-label>
          <div class="chips-input__list">
            <mat-chip-list>
              <mat-chip *ngFor="let control of keywordsArray.controls; let i = index" (removed)="removeKeyword(i)">
                {{ control.value }}
                <button matChipRemove><mat-icon>close</mat-icon></button>
              </mat-chip>
            </mat-chip-list>
          </div>
          <input
            matInput
            placeholder="Add keyword"
            #keywordInput
            (keyup.enter)="addKeyword(keywordInput.value); keywordInput.value = ''"
          />
        </div>

        <div class="seo-preview tab-grid__full">
          <h3>Preview</h3>
          <p class="seo-preview__title">{{ form.controls.metaTitle.value || form.controls.name.value }}</p>
          <p class="seo-preview__url">{{ form.controls.slug.value }}</p>
          <p class="seo-preview__description">{{ form.controls.metaDescription.value || form.controls.description.value }}</p>
        </div>
      </div>
    </mat-tab>

    <mat-tab label="Attributes">
      <app-product-attributes-panel [productId]="productId" [disabled]="!productId"></app-product-attributes-panel>
    </mat-tab>

    <mat-tab label="Variants">
      <app-product-variants-panel [productId]="productId" [disabled]="!productId"></app-product-variants-panel>
    </mat-tab>
  </mat-tab-group>
</section>
