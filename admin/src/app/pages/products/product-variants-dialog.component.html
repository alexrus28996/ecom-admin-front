<ng-container *ngIf="canManageVariants$ | async as canManage">
<div class="dialog-header">
  <div class="dialog-title-section">
    <div class="dialog-icon">
      <mat-icon>tune</mat-icon>
    </div>
    <div class="dialog-title-content">
      <h2 mat-dialog-title class="dialog-title">
        {{ 'products.variants.title' | translate:{ name: productName } }}
      </h2>
      <p class="dialog-subtitle">{{ 'products.variants.subtitle' | translate }}</p>
    </div>
  </div>
  <div class="dialog-stats" *ngIf="!loading">
    <div class="stat-item">
      <span class="stat-value">{{ summary.total }}</span>
      <span class="stat-label">{{ 'products.variants.stats.total' | translate }}</span>
    </div>
    <div class="stat-item">
      <span class="stat-value">{{ summary.active }}</span>
      <span class="stat-label">{{ 'products.variants.stats.active' | translate }}</span>
    </div>
    <div class="stat-item">
      <span class="stat-value">{{ summary.stock }}</span>
      <span class="stat-label">{{ 'products.variants.stats.stock' | translate }}</span>
    </div>
  </div>
</div>

<mat-dialog-content class="dialog-content">
  <div class="dialog-loading" *ngIf="loading">
    <app-loading [show]="loading" labelKey="common.loading"></app-loading>
  </div>

  <app-error-banner [key]="errorKey" [error]="lastError" *ngIf="errorKey"></app-error-banner>

  <div class="variants-list" *ngIf="!loading">
    <div class="variant-item" *ngFor="let variant of variants.controls; let i = index; trackBy: trackByIndex" [formGroup]="variant">
      <div class="variant-header">
        <div class="variant-title-section">
          <div class="variant-number">
            <span>{{ i + 1 }}</span>
          </div>
          <div class="variant-info">
            <h4 class="variant-title">{{ 'products.variants.itemTitle' | translate:{ index: i + 1 } }}</h4>
            <div class="variant-meta">
              <span class="variant-status" [class.variant-status--active]="variant.get('isActive')?.value">
                {{ (variant.get('isActive')?.value ? 'products.variants.status.active' : 'products.variants.status.inactive') | translate }}
              </span>
              <span class="variant-sku" *ngIf="variant.get('sku')?.value">
                SKU: {{ variant.get('sku')?.value }}
              </span>
            </div>
          </div>
        </div>
        <div class="variant-actions">
          <button mat-icon-button color="warn" type="button" (click)="removeVariant(i)" [disabled]="!canManage" matTooltip="{{ 'products.variants.actions.remove' | translate }}">
            <mat-icon>delete</mat-icon>
          </button>
        </div>
      </div>
      <div class="variant-content">
        <div class="variant-grid">
          <mat-form-field appearance="outline">
            <mat-label>{{ 'products.variants.fields.sku' | translate }}</mat-label>
            <input matInput formControlName="sku" [placeholder]="'products.variants.fields.skuPlaceholder' | translate" />
            <mat-icon matPrefix>qr_code</mat-icon>
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label>{{ 'products.variants.fields.stock' | translate }}</mat-label>
            <input matInput type="number" min="0" formControlName="stock" [placeholder]="'0'" />
            <mat-icon matPrefix>inventory</mat-icon>
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label>{{ 'products.variants.fields.price' | translate }}</mat-label>
            <input matInput type="number" min="0" step="0.01" formControlName="price" [placeholder]="'0.00'" />
            <span matPrefix>{{ getCurrencySymbol() }}</span>
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label>{{ 'products.variants.fields.priceDelta' | translate }}</mat-label>
            <input matInput type="number" step="0.01" formControlName="priceDelta" [placeholder]="'±0.00'" />
            <span matPrefix>±</span>
            <mat-hint>{{ 'products.variants.fields.priceDeltaHint' | translate }}</mat-hint>
          </mat-form-field>
          <div class="variant-toggle-field">
            <mat-slide-toggle formControlName="isActive" color="primary">
              <span class="toggle-content">
                <mat-icon>{{ variant.get('isActive')?.value ? 'visibility' : 'visibility_off' }}</mat-icon>
                {{ 'products.variants.fields.isActive' | translate }}
              </span>
            </mat-slide-toggle>
          </div>
        </div>

        <div class="variant-attributes">
          <div class="variant-attributes-header">
            <h4>{{ 'products.variants.fields.attributes' | translate }}</h4>
            <button
              mat-stroked-button
              color="primary"
              type="button"
              (click)="addVariantAttribute(i)"
              [disabled]="!canManage"
            >
              <mat-icon>add</mat-icon>
              {{ 'products.variants.actions.addAttribute' | translate }}
            </button>
          </div>
          <div class="attribute-item" *ngFor="let attr of variantAttributes(i).controls; let j = index" [formGroup]="attr">
            <mat-form-field appearance="outline" class="attribute-key">
              <mat-label>{{ 'products.variants.fields.attributeKey' | translate }}</mat-label>
              <input matInput formControlName="key" [placeholder]="'products.variants.fields.attributeKeyPlaceholder' | translate" />
              <mat-icon matPrefix>label</mat-icon>
            </mat-form-field>
            <mat-form-field appearance="outline" class="attribute-value">
              <mat-label>{{ 'products.variants.fields.attributeValue' | translate }}</mat-label>
              <input matInput formControlName="value" [placeholder]="'products.variants.fields.attributeValuePlaceholder' | translate" />
              <mat-icon matPrefix>text_fields</mat-icon>
            </mat-form-field>
            <button
              mat-icon-button
              color="warn"
              type="button"
              (click)="removeVariantAttribute(i, j)"
              [disabled]="!canManage"
              matTooltip="{{ 'products.variants.actions.removeAttribute' | translate }}"
              class="attribute-remove"
            >
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="dialog-actions-section" *ngIf="!loading">
    <button mat-raised-button color="primary" type="button" (click)="addVariant()" [disabled]="!canManage" class="add-variant-btn">
      <mat-icon>add</mat-icon>
      {{ 'products.variants.actions.addVariant' | translate }}
    </button>
  </div>
</mat-dialog-content>

<mat-dialog-actions align="end" class="dialog-footer">
  <button mat-stroked-button type="button" (click)="cancel()" [disabled]="saving">
    {{ 'common.actions.cancel' | translate }}
  </button>
  <button mat-raised-button color="primary" type="button" (click)="save()" [disabled]="saving || !canManage" class="save-btn">
    <mat-icon *ngIf="saving">hourglass_empty</mat-icon>
    <mat-icon *ngIf="!saving">save</mat-icon>
    {{ (saving ? 'products.variants.actions.saving' : 'products.variants.actions.save') | translate }}
  </button>
</mat-dialog-actions>
</ng-container>
