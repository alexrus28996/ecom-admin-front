<div class="page page--panel">
  <section class="page__header">
    <div class="page__headline">
      <div>
        <span class="page__eyebrow">People</span>
        <h1>{{ 'adminUsers.list.title' | translate }}</h1>
        <p>{{ 'adminUsers.list.subtitle' | translate }}</p>
      </div>
      <div class="page__actions">
        <button mat-stroked-button color="primary" type="button" (click)="onSearch()" [disabled]="loading">
          <mat-icon>refresh</mat-icon>
          {{ 'adminUsers.list.actions.refresh' | translate }}
        </button>
        <button mat-stroked-button type="button" (click)="exportCsv()" [disabled]="loading || !rows.length">
          <mat-icon>file_download</mat-icon>
          {{ 'adminUsers.list.actions.export' | translate }}
        </button>
        <button mat-raised-button color="accent" type="button" (click)="documentation.toggle = !documentation.toggle">
          <mat-icon>menu_book</mat-icon>
          {{ 'adminUsers.permissions.doc.cta' | translate }}
        </button>
      </div>
    </div>
    <form class="page__filters" (ngSubmit)="onSearch()" novalidate>
      <mat-form-field appearance="outline">
        <mat-label>{{ 'adminUsers.list.filters.search' | translate }}</mat-label>
        <input matInput [formControl]="q" [placeholder]="'adminUsers.list.filters.placeholder' | translate" />
        <button mat-icon-button matSuffix type="submit" [disabled]="loading">
          <mat-icon>search</mat-icon>
        </button>
      </mat-form-field>
    </form>
  </section>

  <section class="page__info" [class.page__info--expanded]="documentation.toggle">
    <mat-expansion-panel [expanded]="documentation.toggle" (opened)="documentation.toggle = true" (closed)="documentation.toggle = false">
      <mat-expansion-panel-header>
        <mat-panel-title>
          <mat-icon>verified_user</mat-icon>
          {{ 'adminUsers.permissions.doc.title' | translate }}
        </mat-panel-title>
        <mat-panel-description>
          {{ 'adminUsers.permissions.doc.subtitle' | translate }}
        </mat-panel-description>
      </mat-expansion-panel-header>
      <div class="doc-grid">
        <div class="doc-grid__section">
          <h4>{{ 'adminUsers.permissions.doc.sections.overview.title' | translate }}</h4>
          <p>{{ 'adminUsers.permissions.doc.sections.overview.body' | translate }}</p>
          <ul>
            <li>{{ 'adminUsers.permissions.doc.sections.overview.points.one' | translate }}</li>
            <li>{{ 'adminUsers.permissions.doc.sections.overview.points.two' | translate }}</li>
            <li>{{ 'adminUsers.permissions.doc.sections.overview.points.three' | translate }}</li>
          </ul>
        </div>
        <div class="doc-grid__section">
          <h4>{{ 'adminUsers.permissions.doc.sections.tips.title' | translate }}</h4>
          <p>{{ 'adminUsers.permissions.doc.sections.tips.body' | translate }}</p>
          <ul>
            <li>{{ 'adminUsers.permissions.doc.sections.tips.points.one' | translate }}</li>
            <li>{{ 'adminUsers.permissions.doc.sections.tips.points.two' | translate }}</li>
            <li>{{ 'adminUsers.permissions.doc.sections.tips.points.three' | translate }}</li>
          </ul>
        </div>
        <div class="doc-grid__section doc-grid__section--highlight">
          <h4>{{ 'adminUsers.permissions.doc.sections.safety.title' | translate }}</h4>
          <p>{{ 'adminUsers.permissions.doc.sections.safety.body' | translate }}</p>
        </div>
      </div>
    </mat-expansion-panel>
  </section>

  <section class="bulk-actions" *ngIf="selectionCount()">
    <div class="bulk-actions__summary">
      <mat-icon>select_check_box</mat-icon>
      <span>
        {{ 'adminUsers.list.bulk.selected' | translate:{ count: selectionCount() } }}
      </span>
    </div>
    <div class="bulk-actions__buttons">
      <button mat-stroked-button color="primary" type="button" (click)="bulkActivate()" [disabled]="bulkLoading">
        <mat-progress-spinner *ngIf="bulkLoading" diameter="16" mode="indeterminate"></mat-progress-spinner>
        <mat-icon *ngIf="!bulkLoading">toggle_on</mat-icon>
        {{ 'adminUsers.list.bulk.activate' | translate }}
      </button>
      <button mat-stroked-button color="warn" type="button" (click)="bulkDeactivate()" [disabled]="bulkLoading">
        <mat-progress-spinner *ngIf="bulkLoading" diameter="16" mode="indeterminate"></mat-progress-spinner>
        <mat-icon *ngIf="!bulkLoading">toggle_off</mat-icon>
        {{ 'adminUsers.list.bulk.deactivate' | translate }}
      </button>
    </div>
  </section>

  <section class="page__body">
    <app-loading [show]="loading" labelKey="common.loading"></app-loading>
    <div class="data-table" *ngIf="rows.length; else emptyState">
      <table mat-table [dataSource]="rows" class="data-table__table">
        <ng-container matColumnDef="select">
          <th mat-header-cell *matHeaderCellDef>
            <mat-checkbox
              (change)="toggleAll($event.checked)"
              [checked]="isAllSelected()"
              [indeterminate]="selectionCount() && !isAllSelected()"
              [disabled]="loading"
              aria-label="{{ 'adminUsers.list.table.selectAll' | translate }}"
            ></mat-checkbox>
          </th>
          <td mat-cell *matCellDef="let u">
            <mat-checkbox
              [checked]="selection.isSelected(u.id)"
              (change)="toggleSelection(u, $event.checked)"
              [disabled]="loading"
              aria-label="{{ 'adminUsers.list.table.selectUser' | translate:{ name: u.name || u.email } }}"
            ></mat-checkbox>
          </td>
        </ng-container>

        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef>{{ 'adminUsers.list.table.name' | translate }}</th>
          <td mat-cell *matCellDef="let u">
            <div class="user-name">
              <span>{{ u.name || ('adminUsers.list.table.unknown' | translate) }}</span>
              <small class="muted">{{ u.id }}</small>
            </div>
          </td>
        </ng-container>

        <ng-container matColumnDef="email">
          <th mat-header-cell *matHeaderCellDef>{{ 'adminUsers.list.table.email' | translate }}</th>
          <td mat-cell *matCellDef="let u">{{ u.email }}</td>
        </ng-container>

        <ng-container matColumnDef="roles">
          <th mat-header-cell *matHeaderCellDef>{{ 'adminUsers.list.table.roles' | translate }}</th>
          <td mat-cell *matCellDef="let u">
            <mat-chip-set aria-label="Roles">
              <mat-chip *ngFor="let role of u.roles" [color]="role === 'admin' ? 'primary' : undefined" [selected]="role === 'admin'">
                {{ role }}
              </mat-chip>
            </mat-chip-set>
          </td>
        </ng-container>

        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>{{ 'adminUsers.list.table.status' | translate }}</th>
          <td mat-cell *matCellDef="let u">
            <div class="status-toggle">
              <mat-slide-toggle
                [checked]="u.isActive"
                (change)="toggle(u)"
                [disabled]="statusLoading.has(u.id)"
                color="primary"
              >
                {{ u.isActive ? ('adminUsers.list.status.active' | translate) : ('adminUsers.list.status.inactive' | translate) }}
              </mat-slide-toggle>
              <mat-progress-spinner *ngIf="statusLoading.has(u.id)" diameter="20" mode="indeterminate"></mat-progress-spinner>
            </div>
          </td>
        </ng-container>

        <ng-container matColumnDef="createdAt">
          <th mat-header-cell *matHeaderCellDef>{{ 'adminUsers.list.table.createdAt' | translate }}</th>
          <td mat-cell *matCellDef="let u">{{ u.createdAt | date: 'medium' }}</td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>{{ 'adminUsers.list.table.actions' | translate }}</th>
          <td mat-cell *matCellDef="let u">
            <div class="table-actions">
              <button mat-button type="button" (click)="navigateTo(u)" matTooltip="{{ 'adminUsers.list.actions.view' | translate }}">
                <mat-icon>visibility</mat-icon>
                <span>{{ 'adminUsers.list.actions.view' | translate }}</span>
              </button>
              <button
                mat-button
                color="primary"
                type="button"
                (click)="promote(u)"
                [disabled]="roleLoading.has(u.id) || u.roles?.includes('admin')"
                matTooltip="{{ 'adminUsers.list.actions.promote' | translate }}"
              >
                <mat-progress-spinner *ngIf="roleLoading.has(u.id)" diameter="16" mode="indeterminate"></mat-progress-spinner>
                <mat-icon *ngIf="!roleLoading.has(u.id)">upgrade</mat-icon>
                <span>{{ 'adminUsers.list.actions.promote' | translate }}</span>
              </button>
              <button
                mat-button
                color="warn"
                type="button"
                (click)="demote(u)"
                [disabled]="roleLoading.has(u.id) || !u.roles?.includes('admin') || isLastAdmin(u)"
                matTooltip="{{ isLastAdmin(u) ? ('adminUsers.list.actions.demoteDisabled' | translate) : ('adminUsers.list.actions.demote' | translate) }}"
              >
                <mat-progress-spinner *ngIf="roleLoading.has(u.id)" diameter="16" mode="indeterminate"></mat-progress-spinner>
                <mat-icon *ngIf="!roleLoading.has(u.id)">download</mat-icon>
                <span>{{ 'adminUsers.list.actions.demote' | translate }}</span>
              </button>
              <button
                mat-raised-button
                color="primary"
                type="button"
                (click)="managePermissions(u)"
                matTooltip="{{ 'adminUsers.permissions.actions.manage' | translate }}"
                aria-label="{{ 'adminUsers.permissions.actions.manage' | translate }}"
              >
                <mat-icon>admin_panel_settings</mat-icon>
                <span>{{ 'adminUsers.permissions.actions.manage' | translate }}</span>
              </button>
            </div>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayed; sticky: true"></tr>
        <tr mat-row *matRowDef="let row; columns: displayed" [class.row--selected]="selection.isSelected(row.id)"></tr>
      </table>
    </div>
    <ng-template #emptyState>
      <div class="empty-state">
        <mat-icon>group</mat-icon>
        <p>{{ 'adminUsers.list.empty' | translate }}</p>
      </div>
    </ng-template>
    <app-error-banner [key]="errorKey"></app-error-banner>
  </section>

  <section class="page__footer">
    <mat-paginator
      [length]="total"
      [pageIndex]="pageIndex"
      [pageSize]="pageSize"
      [pageSizeOptions]="pageSizeOptions"
      (page)="onPage($event)"
      showFirstLastButtons
    ></mat-paginator>
  </section>
</div>
