<ng-container *ngIf="categoryPermissions$ | async as perms">
<div class="categories-panel">
  <header class="categories-panel__header">
    <div class="categories-panel__title">
      <h1>{{ 'categories.title' | translate }}</h1>
      <p>{{ 'categories.subtitle' | translate }}</p>
    </div>
    <div class="categories-panel__actions">
      <button
        mat-raised-button
        color="primary"
        type="button"
        (click)="openCreate()"
        [disabled]="!perms.create"
      >
        <mat-icon>add</mat-icon>
        {{ 'categories.addButton' | translate }}
      </button>
    </div>
  </header>

  <form class="categories-panel__filters" [formGroup]="filterForm" (ngSubmit)="onSubmit()" novalidate>
    <mat-form-field appearance="outline">
      <mat-label>{{ 'categories.filters.search.label' | translate }}</mat-label>
      <input
        matInput
        formControlName="q"
        [placeholder]="'categories.filters.search.placeholder' | translate"
      />
      <button mat-icon-button matSuffix type="submit">
        <mat-icon>search</mat-icon>
      </button>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>{{ 'categories.filters.parent.label' | translate }}</mat-label>
      <mat-select formControlName="parent">
        <mat-option value="">{{ 'categories.filters.parent.any' | translate }}</mat-option>
        <mat-option *ngFor="let option of parents" [value]="option.id">
          {{ option.name }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <button mat-stroked-button color="primary" type="submit" class="apply-button">
      {{ 'categories.filters.apply' | translate }}
    </button>
  </form>

  <section class="categories-panel__table">
    <app-loading [show]="loading" labelKey="common.loading"></app-loading>

    <div class="table-wrapper" *ngIf="dataSource.length; else emptyState">
      <table mat-table [dataSource]="dataSource" class="categories-table">
        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef>{{ 'categories.table.name' | translate }}</th>
          <td mat-cell *matCellDef="let category">
            <div class="name-cell">
              <span class="name-cell__primary">{{ category.name }}</span>
              <span class="name-cell__meta">{{ category._id }}</span>
            </div>
          </td>
        </ng-container>

        <ng-container matColumnDef="slug">
          <th mat-header-cell *matHeaderCellDef>{{ 'categories.table.slug' | translate }}</th>
          <td mat-cell *matCellDef="let category">{{ category.slug || ('common.empty' | translate) }}</td>
        </ng-container>

        <ng-container matColumnDef="parent">
          <th mat-header-cell *matHeaderCellDef>{{ 'categories.table.parent' | translate }}</th>
          <td mat-cell *matCellDef="let category">{{ parentLabel(category) }}</td>
        </ng-container>

        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>{{ 'categories.table.status' | translate }}</th>
          <td mat-cell *matCellDef="let category">
            <span [class.is-inactive]="isCategoryDeleted(category)">{{ categoryStatus(category) }}</span>
          </td>
        </ng-container>

        <ng-container matColumnDef="createdAt">
          <th mat-header-cell *matHeaderCellDef>{{ 'categories.table.createdAt' | translate }}</th>
          <td mat-cell *matCellDef="let category">{{ category.createdAt | date:'medium' }}</td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef class="actions-header">{{ 'categories.table.actions' | translate }}</th>
          <td mat-cell *matCellDef="let category">
            <div class="row-actions">
              <button
                mat-icon-button
                color="primary"
                type="button"
                (click)="openEdit(category)"
                [disabled]="!perms.update"
                matTooltip="{{ 'categories.actions.edit' | translate }}"
              >
                <mat-icon>edit</mat-icon>
              </button>
              <button
                mat-icon-button
                color="primary"
                type="button"
                (click)="openReorder(category)"
                [disabled]="!perms.reorder"
                matTooltip="{{ 'categories.actions.reorder' | translate }}"
              >
                <mat-icon>reorder</mat-icon>
              </button>
              <button
                mat-icon-button
                color="accent"
                type="button"
                (click)="confirmRestore(category)"
                [disabled]="!perms.update"
                *ngIf="isCategoryDeleted(category)"
                matTooltip="{{ 'categories.actions.restore' | translate }}"
              >
                <mat-icon>restore</mat-icon>
              </button>
              <button
                mat-icon-button
                color="warn"
                type="button"
                (click)="confirmDelete(category)"
                [disabled]="!perms.delete"
                *ngIf="!isCategoryDeleted(category)"
                matTooltip="{{ 'categories.actions.delete' | translate }}"
              >
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns; trackBy: trackById"></tr>
      </table>
    </div>
  </section>

  <ng-template #emptyState>
    <div class="empty-state">
      <mat-icon>category</mat-icon>
      <p>{{ 'categories.empty' | translate }}</p>
    </div>
  </ng-template>

  <footer class="categories-panel__footer" *ngIf="total > 0">
    <mat-paginator
      [length]="total"
      [pageIndex]="pageIndex"
      [pageSize]="pageSize"
      [pageSizeOptions]="pageSizeOptions"
      (page)="onPageChange($event)"
      showFirstLastButtons
    ></mat-paginator>
  </footer>

  <app-error-banner [key]="errorKey" [error]="lastError"></app-error-banner>
</div>
</ng-container>
