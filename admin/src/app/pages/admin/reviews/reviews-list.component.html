<div class="page page--panel reviews-panel">
  <section class="page__header">
    <div class="page__headline">
      <div>
        <span class="page__eyebrow">{{ 'reviews.page.eyebrow' | translate }}</span>
        <h1>{{ 'reviews.page.title' | translate }}</h1>
        <p>{{ 'reviews.page.subtitle' | translate }}</p>
      </div>
      <div class="page__actions">
        <button mat-stroked-button color="primary" type="button" (click)="load()" [disabled]="loading">
          <mat-icon>refresh</mat-icon>
          {{ 'reviews.actions.refresh' | translate }}
        </button>
      </div>
    </div>
    <form class="page__filters" [formGroup]="filterForm" (ngSubmit)="applyFilters()" novalidate>
      <mat-form-field appearance="outline">
        <mat-label>{{ 'reviews.filters.status' | translate }}</mat-label>
        <mat-select formControlName="status">
          <mat-option value="">{{ 'reviews.filters.anyStatus' | translate }}</mat-option>
          <mat-option value="pending">{{ 'reviews.status.pending' | translate }}</mat-option>
          <mat-option value="approved">{{ 'reviews.status.approved' | translate }}</mat-option>
          <mat-option value="rejected">{{ 'reviews.status.rejected' | translate }}</mat-option>
        </mat-select>
      </mat-form-field>
      <mat-form-field appearance="outline">
        <mat-label>{{ 'reviews.filters.rating' | translate }}</mat-label>
        <mat-select formControlName="rating">
          <mat-option value="">{{ 'reviews.filters.anyRating' | translate }}</mat-option>
          <mat-option *ngFor="let r of [5,4,3,2,1]" [value]="r">
            {{ r }} â˜… &amp; {{ 'reviews.filters.up' | translate }}
          </mat-option>
        </mat-select>
      </mat-form-field>
      <mat-form-field appearance="outline" class="reviews-panel__product-filter">
        <mat-label>{{ 'reviews.filters.product' | translate }}</mat-label>
        <input matInput formControlName="product" [placeholder]="'reviews.filters.productPlaceholder' | translate" />
      </mat-form-field>
      <mat-form-field appearance="outline">
        <mat-label>{{ 'reviews.filters.range' | translate }}</mat-label>
        <mat-date-range-input [rangePicker]="picker" formGroupName="range">
          <input matStartDate formControlName="start" [placeholder]="'reviews.filters.from' | translate" />
          <input matEndDate formControlName="end" [placeholder]="'reviews.filters.to' | translate" />
        </mat-date-range-input>
        <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
        <mat-date-range-picker #picker></mat-date-range-picker>
      </mat-form-field>
      <button mat-raised-button color="primary" type="submit" [disabled]="loading">
        <mat-icon>filter_alt</mat-icon>
        {{ 'reviews.actions.apply' | translate }}
      </button>
      <button mat-button type="button" (click)="resetFilters()" [disabled]="loading">
        {{ 'reviews.actions.reset' | translate }}
      </button>
    </form>
  </section>

  <section class="page__body">
    <app-loading [show]="loading" labelKey="common.loading"></app-loading>

    <div class="reviews-error" *ngIf="error && !loading">
      <mat-icon color="warn">error</mat-icon>
      <span>{{ error }}</span>
    </div>

    <div class="data-table reviews-table" *ngIf="!loading && reviews.length > 0; else emptyState">
      <table mat-table [dataSource]="reviews" class="data-table__table">
        <ng-container matColumnDef="reviewId">
          <th mat-header-cell *matHeaderCellDef>{{ 'reviews.table.review' | translate }}</th>
          <td mat-cell *matCellDef="let review">
            <div class="reviews-id">
              <span>{{ reviewId(review) }}</span>
              <small *ngIf="isFlagged(review)" class="reviews-flag" matTooltip="{{ 'reviews.flags.reported' | translate }}">
                <mat-icon>flag</mat-icon>
              </small>
            </div>
          </td>
        </ng-container>

        <ng-container matColumnDef="product">
          <th mat-header-cell *matHeaderCellDef>{{ 'reviews.table.product' | translate }}</th>
          <td mat-cell *matCellDef="let review">
            <a
              class="reviews-product"
              [routerLink]="(review.product?._id || review.product?.id) ? ['/admin/products', review.product?._id || review.product?.id, 'edit'] : null"
            >
              <img
                *ngIf="review.product?.thumbnailUrl"
                [src]="review.product?.thumbnailUrl"
                [alt]="review.product?.name || 'Product'"
              />
              <div>
                <strong>{{ review.product?.name || ('reviews.table.unknownProduct' | translate) }}</strong>
                <small>{{ review.product?.id || review.product?.slug }}</small>
              </div>
            </a>
          </td>
        </ng-container>

        <ng-container matColumnDef="user">
          <th mat-header-cell *matHeaderCellDef>{{ 'reviews.table.user' | translate }}</th>
          <td mat-cell *matCellDef="let review">
            <div class="reviews-user">
              <strong>{{ review.user?.name || ('reviews.table.guest' | translate) }}</strong>
              <small>{{ review.user?.email }}</small>
            </div>
          </td>
        </ng-container>

        <ng-container matColumnDef="rating">
          <th mat-header-cell *matHeaderCellDef>{{ 'reviews.table.rating' | translate }}</th>
          <td mat-cell *matCellDef="let review">
            <div class="reviews-rating" matTooltip="{{ review.rating || 0 }} / 5">
              <mat-icon *ngFor="let star of ratingArray(review.rating); let i = index" [class.filled]="star === 1">
                {{ star === 1 ? 'star' : 'star_border' }}
              </mat-icon>
            </div>
          </td>
        </ng-container>

        <ng-container matColumnDef="comment">
          <th mat-header-cell *matHeaderCellDef>{{ 'reviews.table.comment' | translate }}</th>
          <td mat-cell *matCellDef="let review">
            <div class="reviews-comment" [class.reviews-comment--expanded]="isExpanded(review)">
              {{ review.comment || ('reviews.table.noComment' | translate) }}
            </div>
            <button
              mat-button
              type="button"
              class="reviews-comment__toggle"
              *ngIf="review.comment && review.comment.length > 140"
              (click)="toggleComment(review)"
            >
              {{ isExpanded(review) ? ('reviews.actions.collapse' | translate) : ('reviews.actions.expand' | translate) }}
            </button>
          </td>
        </ng-container>

        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>{{ 'reviews.table.status' | translate }}</th>
          <td mat-cell *matCellDef="let review">
            <span class="status-badge" [ngClass]="'status-badge--' + (review.status || 'pending')">
              {{ ('reviews.status.' + (review.status || 'pending')) | translate }}
            </span>
          </td>
        </ng-container>

        <ng-container matColumnDef="createdAt">
          <th mat-header-cell *matHeaderCellDef>{{ 'reviews.table.created' | translate }}</th>
          <td mat-cell *matCellDef="let review">{{ review.createdAt | date: 'medium' }}</td>
        </ng-container>

        <ng-container matColumnDef="media">
          <th mat-header-cell *matHeaderCellDef>{{ 'reviews.table.media' | translate }}</th>
          <td mat-cell *matCellDef="let review">
            <div class="reviews-media" *ngIf="review.media?.length; else noMedia">
              <a
                *ngFor="let media of review.media"
                class="reviews-media__item"
                [ngClass]="{ 'reviews-media__item--video': media.type?.includes('video') }"
                [href]="media.url"
                target="_blank"
                rel="noopener"
              >
                <ng-container *ngIf="media.type?.includes('video'); else imagePreview">
                  <mat-icon>play_circle</mat-icon>
                </ng-container>
                <ng-template #imagePreview>
                  <img [src]="media.thumbnailUrl || media.url" alt="Media" />
                </ng-template>
              </a>
            </div>
            <ng-template #noMedia>
              <span class="muted">{{ 'reviews.table.noMedia' | translate }}</span>
            </ng-template>
          </td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>{{ 'reviews.table.actions' | translate }}</th>
          <td mat-cell *matCellDef="let review">
            <div class="table-actions">
              <button
                mat-icon-button
                color="primary"
                (click)="approve(review)"
                [disabled]="loading || review.status === 'approved'"
                matTooltip="{{ 'reviews.actions.approve' | translate }}"
                aria-label="{{ 'reviews.actions.approve' | translate }}"
              >
                <mat-icon>check</mat-icon>
              </button>
              <button
                mat-icon-button
                color="warn"
                (click)="reject(review)"
                [disabled]="loading || review.status === 'rejected'"
                matTooltip="{{ 'reviews.actions.reject' | translate }}"
                aria-label="{{ 'reviews.actions.reject' | translate }}"
              >
                <mat-icon>close</mat-icon>
              </button>
              <button
                mat-icon-button
                (click)="remove(review)"
                [disabled]="loading"
                matTooltip="{{ 'reviews.actions.delete' | translate }}"
                aria-label="{{ 'reviews.actions.delete' | translate }}"
              >
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr
          mat-row
          *matRowDef="let row; columns: displayedColumns"
          [class.review-row--flagged]="isFlagged(row)"
        ></tr>
      </table>
    </div>

    <ng-template #emptyState>
      <div class="empty-state" *ngIf="!loading && !reviews.length">
        <mat-icon>reviews</mat-icon>
        <p>{{ 'reviews.empty' | translate }}</p>
      </div>
    </ng-template>
  </section>

  <section class="page__footer" *ngIf="total > 0">
    <mat-paginator
      [length]="total"
      [pageIndex]="page"
      [pageSize]="pageSize"
      [pageSizeOptions]="pageSizes"
      (page)="onPageChange($event)"
      showFirstLastButtons
    ></mat-paginator>
  </section>
</div>
