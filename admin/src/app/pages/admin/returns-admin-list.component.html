<div class="page page--panel returns-panel">
  <section class="page__header">
    <div class="page__headline">
      <div>
        <span class="page__eyebrow">After-sales</span>
        <h1>{{ 'returns.list.title' | translate }}</h1>
        <p>{{ 'returns.list.subtitle' | translate }}</p>
      </div>
      <div class="page__actions">
        <button mat-stroked-button color="primary" type="button" (click)="reload()" [disabled]="loading">
          <mat-icon>refresh</mat-icon>
          {{ 'returns.list.actions.refresh' | translate }}
        </button>
      </div>
    </div>
    <form [formGroup]="filterForm" (ngSubmit)="onStatusChange()" class="page__filters" novalidate>
      <mat-form-field appearance="outline">
        <mat-label>{{ 'returns.list.filters.status.label' | translate }}</mat-label>
        <mat-select formControlName="status" (selectionChange)="onStatusChange()">
          <mat-option value="">{{ 'returns.list.filters.status.any' | translate }}</mat-option>
          <mat-option value="requested">{{ 'returns.status.requested' | translate }}</mat-option>
          <mat-option value="approved">{{ 'returns.status.approved' | translate }}</mat-option>
          <mat-option value="rejected">{{ 'returns.status.rejected' | translate }}</mat-option>
          <mat-option value="refunded">{{ 'returns.status.refunded' | translate }}</mat-option>
        </mat-select>
      </mat-form-field>
      <button mat-raised-button color="primary" type="submit" [disabled]="loading">
        <mat-icon>filter_alt</mat-icon>
        {{ 'returns.list.filters.apply' | translate }}
      </button>
    </form>
  </section>

  <section class="page__body">
    <app-loading [show]="loading" labelKey="common.loading"></app-loading>

    <div class="data-table" *ngIf="data?.length; else empty">
      <table mat-table [dataSource]="data" class="data-table__table">
        <ng-container matColumnDef="order">
          <th mat-header-cell *matHeaderCellDef>{{ 'returns.list.table.order' | translate }}</th>
          <td mat-cell *matCellDef="let r">
            <div class="return-order">
              <span>{{ r.order || r.orderId }}</span>
              <small class="muted">{{ r.customer?.email }}</small>
            </div>
          </td>
        </ng-container>
        <ng-container matColumnDef="amount">
          <th mat-header-cell *matHeaderCellDef>{{ 'returns.list.table.amount' | translate }}</th>
          <td mat-cell *matCellDef="let r">{{ r.amount | currency:(r.currency || 'USD'):'symbol':'1.2-2' }}</td>
        </ng-container>
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>{{ 'returns.list.table.status' | translate }}</th>
          <td mat-cell *matCellDef="let r">
            <span class="tag" [ngClass]="r.status">
              {{ ('returns.status.' + (r.status || 'requested')) | translate }}
            </span>
          </td>
        </ng-container>
        <ng-container matColumnDef="requestedAt">
          <th mat-header-cell *matHeaderCellDef>{{ 'returns.list.table.requestedAt' | translate }}</th>
          <td mat-cell *matCellDef="let r">{{ r.createdAt | date:'short' }}</td>
        </ng-container>
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>{{ 'returns.list.table.actions' | translate }}</th>
          <td mat-cell *matCellDef="let r">
            <div class="table-actions">
              <button
                mat-icon-button
                color="primary"
                (click)="open(r)"
                matTooltip="{{ 'returns.list.actions.view' | translate }}"
                aria-label="{{ 'returns.list.actions.view' | translate }}"
              >
                <mat-icon>visibility</mat-icon>
              </button>
              <button
                mat-icon-button
                color="primary"
                (click)="approve(r)"
                *ngIf="r.status==='requested'"
                [disabled]="loading || !(canManage$ | async)"
                matTooltip="{{ 'returns.list.actions.approve' | translate }}"
                aria-label="{{ 'returns.list.actions.approve' | translate }}"
              >
                <mat-icon>check</mat-icon>
              </button>
              <button
                mat-icon-button
                color="warn"
                (click)="reject(r)"
                *ngIf="r.status==='requested'"
                [disabled]="loading || !(canManage$ | async)"
                matTooltip="{{ 'returns.list.actions.reject' | translate }}"
                aria-label="{{ 'returns.list.actions.reject' | translate }}"
              >
                <mat-icon>close</mat-icon>
              </button>
            </div>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayed; sticky: true"></tr>
        <tr mat-row *matRowDef="let row; columns: displayed" (click)="open(row)"></tr>
      </table>
    </div>

    <ng-template #empty>
      <div class="empty-state">
        <mat-icon>assignment_return</mat-icon>
        <p>{{ 'returns.list.empty' | translate }}</p>
      </div>
    </ng-template>
  </section>

  <mat-drawer-container autosize hasBackdrop *ngIf="selected" class="returns-drawer">
    <mat-drawer mode="over" position="end" opened>
      <div class="drawer-header">
        <h3>{{ 'returns.list.title' | translate }}</h3>
        <button mat-icon-button (click)="close()"><mat-icon>close</mat-icon></button>
      </div>
      <div class="drawer-body">
        <div class="muted">{{ 'returns.list.detail.id' | translate }}: {{ selected._id || selected.id }}</div>
        <div><strong>{{ 'returns.list.table.order' | translate }}:</strong> {{ selected.order || selected.orderId }}</div>
        <div><strong>{{ 'returns.list.table.amount' | translate }}:</strong> {{ selected.amount | currency:(selected.currency || 'USD'):'symbol':'1.2-2' }}</div>
        <div><strong>{{ 'returns.list.table.status' | translate }}:</strong> {{ ('returns.status.' + (selected.status || 'requested')) | translate }}</div>
        <div *ngIf="selected.reason"><strong>{{ 'returns.list.detail.reason' | translate }}:</strong> {{ selected.reason }}</div>
        <div *ngIf="selected.note"><strong>{{ 'returns.list.detail.note' | translate }}:</strong> {{ selected.note }}</div>
        <div *ngIf="selected.items?.length">
          <strong>Items</strong>
          <ul>
            <li *ngFor="let item of selected.items">
              {{ item.quantity }} Ã— {{ item.name || item.productName || item.sku }}
            </li>
          </ul>
        </div>
        <div *ngIf="selected.createdAt"><strong>{{ 'returns.list.table.requestedAt' | translate }}:</strong> {{ selected.createdAt | date:'short' }}</div>
      </div>
      <div class="drawer-actions">
        <button mat-raised-button color="primary" (click)="approve(selected)" *ngIf="selected.status==='requested'" [disabled]="loading || !(canManage$ | async)">
          <mat-icon>check</mat-icon>
          {{ 'returns.list.actions.approve' | translate }}
        </button>
        <button mat-raised-button color="warn" (click)="reject(selected)" *ngIf="selected.status==='requested'" [disabled]="loading || !(canManage$ | async)">
          <mat-icon>close</mat-icon>
          {{ 'returns.list.actions.reject' | translate }}
        </button>
      </div>
    </mat-drawer>
  </mat-drawer-container>

  <section class="page__footer" *ngIf="total > 0">
    <mat-paginator
      [length]="total"
      [pageIndex]="page"
      [pageSize]="pageSize"
      [pageSizeOptions]="pageSizes"
      (page)="onPage($event)"
      showFirstLastButtons
    ></mat-paginator>
  </section>

  <app-error-banner [key]="errorKey" [error]="lastError"></app-error-banner>
</div>
