<div class="permissions-page">
  <div class="page-header">
    <div>
      <h1>User Permissions Management</h1>
      <p>Control access across the admin workspace with granular permissions.</p>
    </div>
  </div>

  <mat-card class="table-card">
    <div class="table-toolbar">
      <mat-form-field appearance="outline" class="search-field">
        <mat-label>Search users</mat-label>
        <mat-icon matPrefix>search</mat-icon>
        <input matInput [formControl]="searchControl" placeholder="Search by name or email" />
      </mat-form-field>
    </div>

    <mat-progress-bar *ngIf="loading" mode="indeterminate" color="accent"></mat-progress-bar>

    <div class="table-wrapper">
      <table
        mat-table
        [dataSource]="users"
        matSort
        [matSortActive]="sortActive"
        [matSortDirection]="sortDirection"
        class="permissions-table"
      >
        <ng-container matColumnDef="user">
          <th mat-header-cell *matHeaderCellDef mat-sort-header> User </th>
          <td mat-cell *matCellDef="let user">
            <div class="user-cell">
              <div class="avatar" [ngClass]="{ placeholder: !user.avatarUrl }">
                <img *ngIf="user.avatarUrl" [src]="user.avatarUrl" [alt]="user.name || user.email" />
                <span *ngIf="!user.avatarUrl">{{ avatarFallback(user) }}</span>
              </div>
              <div class="user-meta">
                <span class="name">{{ user.name || user.email }}</span>
              </div>
            </div>
          </td>
        </ng-container>

        <ng-container matColumnDef="email">
          <th mat-header-cell *matHeaderCellDef mat-sort-header> Email </th>
          <td mat-cell *matCellDef="let user">{{ user.email }}</td>
        </ng-container>

        <ng-container matColumnDef="roles">
          <th mat-header-cell *matHeaderCellDef> Roles </th>
          <td mat-cell *matCellDef="let user">
            <div class="roles" *ngIf="user.roles?.length; else noRole">
              <span *ngFor="let role of user.roles" [ngClass]="roleClass(role)">{{ role }}</span>
            </div>
            <ng-template #noRole>
              <span class="role-chip muted">none</span>
            </ng-template>
          </td>
        </ng-container>

        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef> Status </th>
          <td mat-cell *matCellDef="let user">
            <span [ngClass]="statusClass(user)">{{ statusLabel(user) }}</span>
          </td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef> Actions </th>
          <td mat-cell *matCellDef="let user">
            <button mat-stroked-button color="primary" (click)="openPermissions(user)">
              <mat-icon>tune</mat-icon>
              Edit Permissions
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns; trackBy: trackByUserId"></tr>
      </table>

      <div class="empty" *ngIf="!loading && users.length === 0">
        <mat-icon>group_off</mat-icon>
        <p>{{ error || 'No users found for the current filters.' }}</p>
      </div>
    </div>

    <mat-paginator
      [length]="total"
      [pageIndex]="pageIndex"
      [pageSize]="pageSize"
      [pageSizeOptions]="[10, 25, 50]"
      showFirstLastButtons
    ></mat-paginator>
  </mat-card>
</div>
