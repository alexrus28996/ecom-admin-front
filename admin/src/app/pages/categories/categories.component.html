<div class="categories-page">
  <header class="page-header">
    <div class="page-header__titles">
      <h1>Categories Management</h1>
      <p class="page-header__subtitle">
        Organise your taxonomy, manage visibility, and optimise SEO metadata for every category.
      </p>
      <nav class="page-header__breadcrumbs" *ngIf="breadcrumbTrail.length">
        <span *ngFor="let crumb of breadcrumbTrail; let last = last" [class.is-active]="last">
          {{ crumb }}
          <mat-icon *ngIf="!last">chevron_right</mat-icon>
        </span>
      </nav>
    </div>
    <button
      mat-raised-button
      color="primary"
      type="button"
      (click)="openCreate()"
      [disabled]="!permissionSnapshot.create"
    >
      <mat-icon>add</mat-icon>
      Create Category
    </button>
  </header>

  <section class="categories-toolbar">
    <mat-form-field appearance="outline" class="search-field">
      <mat-label>Search categories</mat-label>
      <input matInput [formControl]="searchControl" placeholder="Search by name or slug" />
      <button
        mat-icon-button
        matSuffix
        type="button"
        *ngIf="searchControl.value"
        (click)="searchControl.setValue('')"
        aria-label="Clear search"
      >
        <mat-icon>close</mat-icon>
      </button>
      <mat-icon matPrefix>search</mat-icon>
    </mat-form-field>

    <div class="bulk-actions" *ngIf="selection.selected.length">
      <span class="bulk-actions__count">{{ selection.selected.length }} selected</span>
      <button
        mat-stroked-button
        color="primary"
        type="button"
        (click)="openBulkReassign()"
      >
        Reassign Parent
      </button>
      <button
        mat-stroked-button
        color="accent"
        type="button"
        (click)="confirmBulkRestore()"
        [disabled]="!permissionSnapshot.edit || !hasDeletedSelection()"
      >
        Restore Selected
      </button>
      <button
        mat-stroked-button
        color="warn"
        type="button"
        (click)="confirmBulkDelete()"
        [disabled]="!permissionSnapshot.delete"
      >
        Delete Selected
      </button>
    </div>
  </section>

  <mat-progress-bar mode="indeterminate" *ngIf="loading"></mat-progress-bar>

  <section class="categories-tree" [class.is-loading]="loading">
    <div class="tree-wrapper" cdkDropList [cdkDropListData]="dataSource.data" (cdkDropListDropped)="onDrop($event, null)">
      <mat-tree [dataSource]="dataSource" [treeControl]="treeControl" cdkDropListGroup>
        <mat-nested-tree-node
          *matTreeNodeDef="let node; when: hasChild"
          class="tree-node"
          cdkDropList
          [cdkDropListData]="node.children"
          (cdkDropListDropped)="onDrop($event, node)"
        >
          <div class="category-row" [class.is-selected]="isNodeSelected(node)" [class.is-deleted]="node.reference.status === 'deleted'" cdkDrag [cdkDragData]="node">
            <mat-checkbox
              [checked]="isNodeSelected(node)"
              (change)="toggleNodeSelection(node)"
              (click)="$event.stopPropagation()"
            ></mat-checkbox>
            <button mat-icon-button matTreeNodeToggle type="button" (click)="$event.stopPropagation()">
              <mat-icon>
                {{ treeControl.isExpanded(node) ? 'expand_more' : 'chevron_right' }}
              </mat-icon>
            </button>
            <div class="cell cell-name" (click)="selectNode(node)">
              <img *ngIf="node.reference.imageUrl" [src]="node.reference.imageUrl" alt="" class="thumbnail" />
              <div class="cell-name__content">
                <span class="cell-name__primary">{{ node.reference.name }}</span>
                <span class="cell-name__secondary">{{ node.reference.slug || '—' }}</span>
              </div>
            </div>
            <div class="cell cell-parent">{{ parentLabel(node.reference) }}</div>
            <div class="cell cell-status">
              <span class="status-pill" [ngClass]="nodeStatusClass(node.reference)">
                {{ node.reference.status === 'deleted' ? 'Deleted' : node.reference.status === 'inactive' ? 'Inactive' : 'Active' }}
              </span>
            </div>
            <div class="cell cell-order">{{ node.reference.sortOrder ?? '—' }}</div>
            <div class="cell cell-actions">
              <button
                mat-icon-button
                color="primary"
                type="button"
                (click)="openEdit(node)"
                [disabled]="!permissionSnapshot.edit"
              >
                <mat-icon>edit</mat-icon>
              </button>
              <button
                mat-icon-button
                color="accent"
                type="button"
                *ngIf="node.reference.status === 'deleted'"
                (click)="confirmRestore(node)"
                [disabled]="!permissionSnapshot.edit"
              >
                <mat-icon>restore</mat-icon>
              </button>
              <button
                mat-icon-button
                color="warn"
                type="button"
                *ngIf="node.reference.status !== 'deleted'"
                (click)="confirmDelete(node)"
                [disabled]="!permissionSnapshot.delete"
              >
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </div>
          <div class="children-container" *ngIf="treeControl.isExpanded(node)">
            <ng-container matTreeNodeOutlet></ng-container>
          </div>
        </mat-nested-tree-node>

        <mat-tree-node
          *matTreeNodeDef="let node"
          class="tree-node"
          cdkDrag
          [cdkDragData]="node"
        >
          <div class="category-row" [class.is-selected]="isNodeSelected(node)" [class.is-deleted]="node.reference.status === 'deleted'">
            <mat-checkbox
              [checked]="isNodeSelected(node)"
              (change)="toggleNodeSelection(node)"
              (click)="$event.stopPropagation()"
            ></mat-checkbox>
            <span class="toggle-placeholder"></span>
            <div class="cell cell-name" (click)="selectNode(node)">
              <img *ngIf="node.reference.imageUrl" [src]="node.reference.imageUrl" alt="" class="thumbnail" />
              <div class="cell-name__content">
                <span class="cell-name__primary">{{ node.reference.name }}</span>
                <span class="cell-name__secondary">{{ node.reference.slug || '—' }}</span>
              </div>
            </div>
            <div class="cell cell-parent">{{ parentLabel(node.reference) }}</div>
            <div class="cell cell-status">
              <span class="status-pill" [ngClass]="nodeStatusClass(node.reference)">
                {{ node.reference.status === 'deleted' ? 'Deleted' : node.reference.status === 'inactive' ? 'Inactive' : 'Active' }}
              </span>
            </div>
            <div class="cell cell-order">{{ node.reference.sortOrder ?? '—' }}</div>
            <div class="cell cell-actions">
              <button
                mat-icon-button
                color="primary"
                type="button"
                (click)="openEdit(node)"
                [disabled]="!permissionSnapshot.edit"
              >
                <mat-icon>edit</mat-icon>
              </button>
              <button
                mat-icon-button
                color="accent"
                type="button"
                *ngIf="node.reference.status === 'deleted'"
                (click)="confirmRestore(node)"
                [disabled]="!permissionSnapshot.edit"
              >
                <mat-icon>restore</mat-icon>
              </button>
              <button
                mat-icon-button
                color="warn"
                type="button"
                *ngIf="node.reference.status !== 'deleted'"
                (click)="confirmDelete(node)"
                [disabled]="!permissionSnapshot.delete"
              >
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </div>
        </mat-tree-node>
      </mat-tree>
    </div>
    <div class="empty-state" *ngIf="!loading && !currentViewIds.size">
      <mat-icon>category</mat-icon>
      <p>No categories found. Try adjusting your filters or create a new category.</p>
    </div>
  </section>

  <footer class="categories-footer">
    <button mat-button type="button" (click)="masterToggle()">
      {{ isAllSelected() ? 'Clear selection' : 'Select all' }}
    </button>
    <span class="footer-status" *ngIf="errorMessage">{{ errorMessage }}</span>
  </footer>

  <ng-template #reassignParentDialog>
    <h2 mat-dialog-title>Reassign parent</h2>
    <mat-dialog-content>
      <p>Select a new parent category for the selected items.</p>
      <mat-form-field appearance="outline" class="parent-select">
        <mat-label>Parent</mat-label>
        <mat-select [formControl]="parentSelectionControl">
          <mat-option *ngFor="let option of bulkParentOptions" [value]="option.id" [disabled]="option.disabled">
            {{ option.label }}
          </mat-option>
        </mat-select>
      </mat-form-field>
    </mat-dialog-content>
    <mat-dialog-actions align="end">
      <button mat-button type="button" (click)="cancelBulkReassign()">Cancel</button>
      <button mat-raised-button color="primary" type="button" (click)="applyBulkReassign()" [disabled]="parentSelectionControl.invalid">
        Apply
      </button>
    </mat-dialog-actions>
  </ng-template>
</div>
