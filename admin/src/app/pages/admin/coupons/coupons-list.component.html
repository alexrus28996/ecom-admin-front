<div class="page page--panel">
  <section class="page__header">
    <div class="page__headline">
      <div>
        <span class="page__eyebrow">{{ 'coupons.list.eyebrow' | translate }}</span>
        <h1>{{ 'coupons.list.title' | translate }}</h1>
        <p>{{ 'coupons.list.subtitle' | translate }}</p>
      </div>
      <div class="page__actions">
        <button mat-stroked-button color="primary" type="button" (click)="load()" [disabled]="loading">
          <mat-icon>refresh</mat-icon>
          {{ 'coupons.list.actions.refresh' | translate }}
        </button>
        <button mat-flat-button color="primary" type="button" (click)="openCreate()">
          <mat-icon>add</mat-icon>
          {{ 'coupons.list.actions.create' | translate }}
        </button>
      </div>
    </div>
    <form class="page__filters" [formGroup]="filterForm" (ngSubmit)="applyFilters()" novalidate>
      <mat-form-field appearance="outline">
        <mat-label>{{ 'coupons.list.filters.status.label' | translate }}</mat-label>
        <mat-select formControlName="status">
          <mat-option *ngFor="let option of statusOptions" [value]="option.value">{{ option.labelKey | translate }}</mat-option>
        </mat-select>
      </mat-form-field>
      <div class="range-field" formGroupName="range">
        <mat-form-field appearance="outline" class="range-field__field">
          <mat-label>{{ 'coupons.list.filters.range.label' | translate }}</mat-label>
          <mat-date-range-input [rangePicker]="picker">
            <input matStartDate [placeholder]="'coupons.list.filters.range.start' | translate" formControlName="start" />
            <input matEndDate [placeholder]="'coupons.list.filters.range.end' | translate" formControlName="end" />
          </mat-date-range-input>
          <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
          <mat-date-range-picker #picker></mat-date-range-picker>
        </mat-form-field>
      </div>
      <div class="page__filters-actions">
        <button mat-stroked-button type="button" (click)="resetFilters()" [disabled]="loading">
          {{ 'coupons.list.filters.reset' | translate }}
        </button>
        <button mat-raised-button color="primary" type="submit" [disabled]="loading">
          <mat-icon>filter_alt</mat-icon>
          {{ 'common.actions.apply' | translate }}
        </button>
      </div>
    </form>
  </section>

  <section class="page__body">
    <app-loading [show]="loading" labelKey="common.loading"></app-loading>
    <div class="data-table" *ngIf="coupons.length; else emptyState">
      <table mat-table [dataSource]="coupons" class="data-table__table" [trackBy]="trackById">
        <ng-container matColumnDef="code">
          <th mat-header-cell *matHeaderCellDef>{{ 'coupons.list.table.code' | translate }}</th>
          <td mat-cell *matCellDef="let coupon">
            <strong>{{ coupon.code }}</strong>
          </td>
        </ng-container>

        <ng-container matColumnDef="description">
          <th mat-header-cell *matHeaderCellDef>{{ 'coupons.list.table.description' | translate }}</th>
          <td mat-cell *matCellDef="let coupon">
            <span class="muted" *ngIf="!coupon.description">{{ 'common.empty' | translate }}</span>
            <span *ngIf="coupon.description">{{ coupon.description }}</span>
          </td>
        </ng-container>

        <ng-container matColumnDef="type">
          <th mat-header-cell *matHeaderCellDef>{{ 'coupons.list.table.type' | translate }}</th>
          <td mat-cell *matCellDef="let coupon">{{ coupon.type === 'percent' ? ('coupons.list.types.percent' | translate) : ('coupons.list.types.fixed' | translate) }}</td>
        </ng-container>

        <ng-container matColumnDef="value">
          <th mat-header-cell *matHeaderCellDef>{{ 'coupons.list.table.value' | translate }}</th>
          <td mat-cell *matCellDef="let coupon">
            <ng-container [ngSwitch]="coupon.type">
              <span *ngSwitchCase="'percent'">{{ coupon.value }}%</span>
              <span *ngSwitchDefault>{{ coupon.value | number: '1.0-2' }}</span>
            </ng-container>
          </td>
        </ng-container>

        <ng-container matColumnDef="usageLimits">
          <th mat-header-cell *matHeaderCellDef>{{ 'coupons.list.table.usageLimits' | translate }}</th>
          <td mat-cell *matCellDef="let coupon">
            <span>{{ coupon.maxRedemptionsPerUser ?? ('common.empty' | translate) }}</span>
            <span class="muted">/</span>
            <span>{{ coupon.maxRedemptions ?? ('common.empty' | translate) }}</span>
          </td>
        </ng-container>

        <ng-container matColumnDef="usageCount">
          <th mat-header-cell *matHeaderCellDef>{{ 'coupons.list.table.usageCount' | translate }}</th>
          <td mat-cell *matCellDef="let coupon">{{ coupon.usageCount ?? 0 }}</td>
        </ng-container>

        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef>{{ 'coupons.list.table.status' | translate }}</th>
          <td mat-cell *matCellDef="let coupon">
            <span [ngClass]="statusClass(coupon)">{{ ('coupons.list.status.' + resolveStatus(coupon)) | translate }}</span>
          </td>
        </ng-container>

        <ng-container matColumnDef="startsAt">
          <th mat-header-cell *matHeaderCellDef>{{ 'coupons.list.table.startsAt' | translate }}</th>
          <td mat-cell *matCellDef="let coupon">
            <span *ngIf="coupon.startsAt; else dash">{{ coupon.startsAt | date: 'mediumDate' }}</span>
          </td>
        </ng-container>

        <ng-container matColumnDef="expiresAt">
          <th mat-header-cell *matHeaderCellDef>{{ 'coupons.list.table.expiresAt' | translate }}</th>
          <td mat-cell *matCellDef="let coupon">
            <span *ngIf="coupon.expiresAt; else dash">{{ coupon.expiresAt | date: 'mediumDate' }}</span>
          </td>
        </ng-container>

        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>{{ 'coupons.list.table.actions' | translate }}</th>
          <td mat-cell *matCellDef="let coupon">
            <div class="table-actions">
              <button mat-icon-button color="primary" type="button" (click)="editCoupon(coupon)" matTooltip="{{ 'coupons.list.actions.edit' | translate }}">
                <mat-icon>edit</mat-icon>
              </button>
              <button mat-icon-button color="warn" type="button" (click)="deleteCoupon(coupon)" matTooltip="{{ 'coupons.list.actions.delete' | translate }}">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
      </table>
    </div>
    <ng-template #emptyState>
      <div class="empty-state">
        <mat-icon>confirmation_number</mat-icon>
        <p>{{ 'coupons.list.empty' | translate }}</p>
      </div>
    </ng-template>
    <app-error-banner [key]="errorKey"></app-error-banner>
  </section>

  <section class="page__footer" *ngIf="total > 0">
    <mat-paginator
      [length]="total"
      [pageIndex]="pageIndex"
      [pageSize]="pageSize"
      [pageSizeOptions]="pageSizeOptions"
      (page)="onPage($event)"
      showFirstLastButtons
    ></mat-paginator>
  </section>
</div>

<ng-template #dash>
  <span class="muted">{{ 'common.empty' | translate }}</span>
</ng-template>
