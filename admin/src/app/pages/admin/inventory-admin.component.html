<div class="page inventory-shell">
  <section class="page__header">
    <div class="page__headline">
      <div>
        <span class="page__eyebrow">Stock control</span>
        <h1>{{ 'inventory.title' | translate }}</h1>
        <p>{{ 'inventory.subtitle' | translate }}</p>
      </div>
      <div class="page__actions">
        <button mat-stroked-button color="primary" type="button" (click)="loadInv()" [disabled]="invLoading">
          <mat-icon>refresh</mat-icon>
          {{ 'inventory.actions.refresh' | translate }}
        </button>
      </div>
    </div>
  </section>

  <div class="inventory-sections">
    <mat-card class="inventory-card">
      <mat-card-header>
        <mat-card-title>{{ 'inventory.overview.title' | translate }}</mat-card-title>
        <mat-card-subtitle>{{ 'inventory.overview.subtitle' | translate }}</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <form [formGroup]="invFilters" class="inventory-filters" (ngSubmit)="loadInv()">
          <mat-form-field appearance="outline">
            <mat-label>{{ 'inventory.filters.product' | translate }}</mat-label>
            <input matInput formControlName="product" />
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label>{{ 'inventory.filters.variant' | translate }}</mat-label>
            <input matInput formControlName="variant" />
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label>{{ 'inventory.filters.location' | translate }}</mat-label>
            <input matInput formControlName="location" />
          </mat-form-field>
          <button mat-raised-button color="primary" type="submit" [disabled]="invLoading">
            <mat-icon>filter_alt</mat-icon>
            {{ 'inventory.actions.apply' | translate }}
          </button>
        </form>
        <section class="inventory-table">
          <app-loading [show]="invLoading" labelKey="common.loading"></app-loading>
          <div class="data-table" *ngIf="inv.items?.length; else invEmpty">
            <table mat-table [dataSource]="inv.items" class="data-table__table">
              <ng-container matColumnDef="product">
                <th mat-header-cell *matHeaderCellDef>{{ 'inventory.table.product' | translate }}</th>
                <td mat-cell *matCellDef="let r">{{ r.product || r.productId }}</td>
              </ng-container>
              <ng-container matColumnDef="variant">
                <th mat-header-cell *matHeaderCellDef>{{ 'inventory.table.variant' | translate }}</th>
                <td mat-cell *matCellDef="let r">{{ r.variant || r.variantId || '-' }}</td>
              </ng-container>
              <ng-container matColumnDef="stock">
                <th mat-header-cell *matHeaderCellDef>{{ 'inventory.table.stock' | translate }}</th>
                <td mat-cell *matCellDef="let r">{{ r.stock ?? r.quantity ?? 0 }}</td>
              </ng-container>
              <tr mat-header-row *matHeaderRowDef="['product','variant','stock']; sticky: true"></tr>
              <tr mat-row *matRowDef="let row; columns: ['product','variant','stock']"></tr>
            </table>
          </div>
          <ng-template #invEmpty>
            <div class="empty-state">
              <mat-icon>inventory_2</mat-icon>
              <p>{{ 'inventory.overview.empty' | translate }}</p>
            </div>
          </ng-template>
          <app-error-banner [key]="invErrorKey"></app-error-banner>
        </section>
      </mat-card-content>
      <mat-card-actions align="end">
        <mat-paginator
          [length]="inv.total"
          [pageIndex]="inv.page"
          [pageSize]="inv.pageSize"
          [pageSizeOptions]="[10,25,50,100]"
          (page)="pageInv($event)"
          showFirstLastButtons
        ></mat-paginator>
      </mat-card-actions>
    </mat-card>

    <mat-card class="inventory-card">
      <mat-card-header>
        <mat-card-title>{{ 'inventory.adjustments.title' | translate }}</mat-card-title>
        <mat-card-subtitle>{{ 'inventory.adjustments.subtitle' | translate }}</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content class="inventory-card__content">
        <form [formGroup]="adjForm" class="inventory-filters" (ngSubmit)="saveAdjustment()">
          <mat-form-field appearance="outline">
            <mat-label>{{ 'inventory.adjust.productId' | translate }}</mat-label>
            <input matInput formControlName="productId" />
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label>{{ 'inventory.adjust.variantId' | translate }}</mat-label>
            <input matInput formControlName="variantId" />
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label>{{ 'inventory.adjust.qtyChange' | translate }}</mat-label>
            <input matInput type="number" formControlName="qtyChange" />
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label>{{ 'inventory.adjust.reason' | translate }}</mat-label>
            <input matInput formControlName="reason" />
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label>{{ 'inventory.adjust.note' | translate }}</mat-label>
            <input matInput formControlName="note" />
          </mat-form-field>
          <button mat-raised-button color="primary" type="submit" [disabled]="adjSaving">
            <mat-icon>playlist_add</mat-icon>
            {{ 'inventory.actions.createAdjustment' | translate }}
          </button>
        </form>
        <form [formGroup]="adjFilters" class="inventory-filters" (ngSubmit)="loadAdj()">
          <mat-form-field appearance="outline">
            <mat-label>{{ 'inventory.filters.product' | translate }}</mat-label>
            <input matInput formControlName="product" />
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label>{{ 'inventory.filters.variant' | translate }}</mat-label>
            <input matInput formControlName="variant" />
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label>{{ 'inventory.filters.reason' | translate }}</mat-label>
            <input matInput formControlName="reason" />
          </mat-form-field>
          <button mat-raised-button color="primary" type="submit" [disabled]="adjLoading">
            <mat-icon>filter_alt</mat-icon>
            {{ 'inventory.actions.apply' | translate }}
          </button>
        </form>
        <section class="inventory-table">
          <app-loading [show]="adjLoading" labelKey="common.loading"></app-loading>
          <div class="data-table" *ngIf="adj.items?.length; else adjEmpty">
            <table mat-table [dataSource]="adj.items" class="data-table__table">
              <ng-container matColumnDef="time">
                <th mat-header-cell *matHeaderCellDef>{{ 'inventory.adjust.table.time' | translate }}</th>
                <td mat-cell *matCellDef="let r">{{ r.time || r.createdAt | date:'short' }}</td>
              </ng-container>
              <ng-container matColumnDef="product">
                <th mat-header-cell *matHeaderCellDef>{{ 'inventory.table.product' | translate }}</th>
                <td mat-cell *matCellDef="let r">{{ r.product || r.productId }}</td>
              </ng-container>
              <ng-container matColumnDef="variant">
                <th mat-header-cell *matHeaderCellDef>{{ 'inventory.table.variant' | translate }}</th>
                <td mat-cell *matCellDef="let r">{{ r.variant || r.variantId || '-' }}</td>
              </ng-container>
              <ng-container matColumnDef="qty">
                <th mat-header-cell *matHeaderCellDef>{{ 'inventory.adjust.table.qtyChange' | translate }}</th>
                <td mat-cell *matCellDef="let r">{{ r.qtyChange }}</td>
              </ng-container>
              <ng-container matColumnDef="reason">
                <th mat-header-cell *matHeaderCellDef>{{ 'inventory.adjust.table.reason' | translate }}</th>
                <td mat-cell *matCellDef="let r">{{ r.reason || '-' }}</td>
              </ng-container>
              <ng-container matColumnDef="note">
                <th mat-header-cell *matHeaderCellDef>{{ 'inventory.adjust.table.note' | translate }}</th>
                <td mat-cell *matCellDef="let r">{{ r.note || '-' }}</td>
              </ng-container>
              <tr mat-header-row *matHeaderRowDef="['time','product','variant','qty','reason','note']; sticky: true"></tr>
              <tr mat-row *matRowDef="let row; columns: ['time','product','variant','qty','reason','note']"></tr>
            </table>
          </div>
          <ng-template #adjEmpty>
            <div class="empty-state">
              <mat-icon>list_alt</mat-icon>
              <p>{{ 'inventory.adjustments.empty' | translate }}</p>
            </div>
          </ng-template>
          <app-error-banner [key]="adjErrorKey"></app-error-banner>
        </section>
      </mat-card-content>
      <mat-card-actions align="end">
        <mat-paginator
          [length]="adj.total"
          [pageIndex]="adj.page"
          [pageSize]="adj.pageSize"
          [pageSizeOptions]="[10,25,50,100]"
          (page)="pageAdj($event)"
          showFirstLastButtons
        ></mat-paginator>
      </mat-card-actions>
    </mat-card>

    <mat-card class="inventory-card">
      <mat-card-header>
        <mat-card-title>{{ 'inventory.low.title' | translate }}</mat-card-title>
        <mat-card-subtitle>{{ 'inventory.low.subtitle' | translate }}</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <form [formGroup]="lowFilters" class="inventory-filters" (ngSubmit)="loadLow()">
          <mat-form-field appearance="outline">
            <mat-label>{{ 'inventory.filters.threshold' | translate }}</mat-label>
            <input matInput type="number" min="0" formControlName="threshold" />
          </mat-form-field>
          <button mat-raised-button color="primary" type="submit" [disabled]="lowLoading">
            <mat-icon>filter_alt</mat-icon>
            {{ 'inventory.actions.apply' | translate }}
          </button>
        </form>
        <section class="inventory-table">
          <app-loading [show]="lowLoading" labelKey="common.loading"></app-loading>
          <div class="data-table" *ngIf="low.items?.length; else lowEmpty">
            <table mat-table [dataSource]="low.items" class="data-table__table">
              <ng-container matColumnDef="product">
                <th mat-header-cell *matHeaderCellDef>{{ 'inventory.table.product' | translate }}</th>
                <td mat-cell *matCellDef="let r">{{ r.product || r.productId }}</td>
              </ng-container>
              <ng-container matColumnDef="variant">
                <th mat-header-cell *matHeaderCellDef>{{ 'inventory.table.variant' | translate }}</th>
                <td mat-cell *matCellDef="let r">{{ r.variant || r.variantId || '-' }}</td>
              </ng-container>
              <ng-container matColumnDef="stock">
                <th mat-header-cell *matHeaderCellDef>{{ 'inventory.table.stock' | translate }}</th>
                <td mat-cell *matCellDef="let r">{{ r.stock ?? r.quantity ?? 0 }}</td>
              </ng-container>
              <tr mat-header-row *matHeaderRowDef="['product','variant','stock']; sticky: true"></tr>
              <tr mat-row *matRowDef="let row; columns: ['product','variant','stock']"></tr>
            </table>
          </div>
          <ng-template #lowEmpty>
            <div class="empty-state">
              <mat-icon>report</mat-icon>
              <p>{{ 'inventory.low.empty' | translate }}</p>
            </div>
          </ng-template>
          <app-error-banner [key]="lowErrorKey"></app-error-banner>
        </section>
      </mat-card-content>
      <mat-card-actions align="end">
        <mat-paginator
          [length]="low.total"
          [pageIndex]="low.page"
          [pageSize]="low.pageSize"
          [pageSizeOptions]="[10,25,50,100]"
          (page)="pageLow($event)"
          showFirstLastButtons
        ></mat-paginator>
      </mat-card-actions>
    </mat-card>
  </div>
</div>
